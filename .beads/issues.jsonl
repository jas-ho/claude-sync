{"id":"claude-sync-06z","title":"Normalize content before hashing (unicode, line endings)","description":"## Problem\n`compute_doc_hash()` doesn't normalize content before hashing, causing false positives (unnecessary re-syncs) when content is semantically identical but differs in encoding.\n\n## Location\nLines 740-742:\n```python\ndef compute_doc_hash(content: str) -\u003e str:\n    \"\"\"Compute hash of document content for change detection.\"\"\"\n    return hashlib.sha256(content.encode(\"utf-8\")).hexdigest()[:16]\n```\n\n## Issues\n\n### 1. Unicode normalization\nSame text can be encoded as NFD or NFC:\n- NFC: \"é\" = single codepoint (U+00E9)\n- NFD: \"é\" = e + combining accent (U+0065 U+0301)\n\nIf API returns NFD one time and NFC another, hashes differ even though content is visually identical.\n\n### 2. Line ending normalization\n- Windows: CRLF (\\r\\n)\n- Unix: LF (\\n)\n- Old Mac: CR (\\r)\n\nIf API sometimes returns CRLF and sometimes LF, hashes differ.\n\n### 3. Trailing whitespace\n- Some editors add trailing newline\n- API might strip or preserve it inconsistently\n\n## Fixed Implementation\n```python\nimport unicodedata\n\ndef compute_doc_hash(content: str) -\u003e str:\n    \"\"\"Compute hash of document content for change detection.\n    \n    Normalizes content before hashing to avoid false positives from:\n    - Unicode normalization differences (NFD vs NFC)\n    - Line ending differences (CRLF vs LF)\n    - Trailing whitespace\n    \"\"\"\n    # Normalize unicode to NFC (consistent form)\n    normalized = unicodedata.normalize(\"NFC\", content)\n    \n    # Normalize line endings to LF\n    normalized = normalized.replace(\"\\r\\n\", \"\\n\").replace(\"\\r\", \"\\n\")\n    \n    # Strip trailing whitespace (optional, may want to preserve)\n    # normalized = normalized.rstrip()\n    \n    return hashlib.sha256(normalized.encode(\"utf-8\")).hexdigest()[:16]\n```\n\n## Gotchas\n- **Breaking change**: Existing hashes in .sync-state.json won't match\n- After deploying this fix, first sync will re-sync ALL projects (hash mismatch)\n- Could add migration: compute both old and new hash, match either\n\n### Migration strategy\n```python\ndef compute_doc_hash(content: str, legacy: bool = False) -\u003e str:\n    if legacy:\n        return hashlib.sha256(content.encode(\"utf-8\")).hexdigest()[:16]\n    # ... normalized version ...\n\ndef content_hash_matches(content: str, stored_hash: str) -\u003e bool:\n    \"\"\"Check if content matches stored hash (with legacy fallback).\"\"\"\n    new_hash = compute_doc_hash(content)\n    if new_hash == stored_hash:\n        return True\n    # Try legacy hash for backward compatibility\n    legacy_hash = compute_doc_hash(content, legacy=True)\n    return legacy_hash == stored_hash\n```\n\n## Test Plan\n1. Create test content with NFD characters\n2. Create same content with NFC\n3. Verify both hash to same value (after fix)\n\n4. Create test content with CRLF\n5. Create same content with LF\n6. Verify both hash to same value\n\n7. Test backward compatibility:\n   - Create .sync-state.json with old hashes\n   - Run sync\n   - Verify projects NOT unnecessarily re-synced (if using migration)\n\n## Before Closing\n- [ ] Add unicode normalization to compute_doc_hash()\n- [ ] Add line ending normalization\n- [ ] Consider backward compatibility migration\n- [ ] Add unit tests for normalization\n- [ ] Document breaking change if no migration\n- [ ] git commit","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-07T15:16:30.464599+01:00","updated_at":"2025-12-07T15:26:44.013662+01:00","closed_at":"2025-12-07T15:26:44.013662+01:00"}
{"id":"claude-sync-0vr","title":"CRITICAL: Project slug collision causes silent data overwrite","description":"## Problem\nTwo different projects with different UUIDs can generate the same directory slug, causing the second project to **silently overwrite** the first project's entire directory.\n\n## Root Cause\n`make_project_slug()` at lines 547-570 uses only the first 8 characters of the UUID after removing dashes:\n\n```python\nshort_uuid = uuid.replace(\"-\", \"\")[:8]  # Line 564\n```\n\nThis provides only 32 bits of uniqueness. Birthday paradox suggests ~1% collision chance at ~77,000 projects, but more critically:\n\n**The real bug**: If two projects have the same name (case-insensitive) AND share the first 8 hex chars of their UUID, they get the same slug.\n\nExample collision scenario:\n1. Project \"Test\" (uuid: `12345678-1111-...`) → slug: `test-12345678`\n2. Project \"TEST\" (uuid: `12345678-2222-...`) → slug: `test-12345678`\n3. Second project overwrites first - **DATA LOSS**\n\n## Evidence from Review\n```python\n# Line 607 - exist_ok=True means no error on collision!\nproject_dir.mkdir(parents=True, exist_ok=True)\n```\n\nThe code at `write_project_output()` uses `exist_ok=True` which silently allows overwriting.\n\n## Implementation Hints\n\n**Option A: Track used slugs (simple)**\n```python\ndef sync(...):\n    used_slugs: dict[str, str] = {}  # slug -\u003e uuid mapping\n    \n    for project in projects:\n        slug = make_project_slug(project['name'], project['uuid'])\n        if slug in used_slugs and used_slugs[slug] != project['uuid']:\n            # Collision! Add more UUID chars\n            slug = make_project_slug(project['name'], project['uuid'], min_uuid_chars=16)\n        used_slugs[slug] = project['uuid']\n```\n\n**Option B: Use full UUID (safest but ugly directories)**\n```python\nshort_uuid = uuid.replace(\"-\", \"\")  # Full 32 chars\n```\n\n**Option C: Check existing directories before write**\n```python\ndef write_project_output(...):\n    # Check if directory exists with DIFFERENT project\n    meta_path = project_dir / 'meta.json'\n    if meta_path.exists():\n        existing = json.loads(meta_path.read_text())\n        if existing['uuid'] != project['uuid']:\n            raise ValueError(f'Slug collision: {project_dir} belongs to {existing[\"uuid\"]}')\n```\n\n## Gotchas\n- Must handle case where user manually renamed directories\n- Must handle case where meta.json is corrupted/missing\n- Consider: should we auto-resolve collisions or fail loudly?\n\n## Test Plan\n1. Create two test project dicts with:\n   - Same name (different case): 'Test' and 'TEST'\n   - UUIDs sharing first 8 chars: '12345678-aaaa-...' and '12345678-bbbb-...'\n2. Sync both projects\n3. Verify BOTH exist (currently fails - second overwrites first)\n4. Verify meta.json in each has correct UUID\n\n## Before Closing\n- [ ] Implement collision detection\n- [ ] Add unit tests for slug collision scenarios\n- [ ] Test with real sync\n- [ ] git commit with test results","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-07T15:12:08.211601+01:00","updated_at":"2025-12-07T15:31:30.834196+01:00","closed_at":"2025-12-07T15:31:30.834196+01:00"}
{"id":"claude-sync-193","title":"Fix orphaned project name always showing as 'Unknown'","description":"## Problem\nWhen detecting deleted/orphaned projects, the name is always shown as \"Unknown\" because the sync state doesn't store project names.\n\n## Location\nLines 1236-1244:\n```python\nprev_project = prev_state.get(\"projects\", {}).get(deleted_uuid, {})\norphaned_projects.append({\n    \"uuid\": deleted_uuid,\n    \"name\": prev_project.get(\"name\", \"Unknown\"),  # Always \"Unknown\"!\n    ...\n})\n```\n\n## Root Cause\nLooking at `build_project_state()` (lines 842-863):\n```python\ndef build_project_state(project: dict, docs: list[dict]) -\u003e dict:\n    return {\n        \"updated_at\": project.get(\"updated_at\", \"\"),\n        \"prompt_template_hash\": compute_doc_hash(...),\n        \"docs\": doc_states,\n        # NO \"name\" KEY!\n    }\n```\n\nThe state dict structure doesn't include the project name.\n\n## Solutions\n\n### Option A: Store name in sync state (recommended)\n```python\ndef build_project_state(project: dict, docs: list[dict]) -\u003e dict:\n    return {\n        \"name\": project.get(\"name\", \"Unknown\"),  # Add this\n        \"updated_at\": project.get(\"updated_at\", \"\"),\n        \"prompt_template_hash\": compute_doc_hash(...),\n        \"docs\": doc_states,\n    }\n```\n\n### Option B: Load name from index.json\n```python\n# In detect_deleted_projects or caller:\nindex = load_index(output_dir)\nfor uuid in deleted_uuids:\n    name = index.get(\"projects\", {}).get(uuid, {}).get(\"name\", \"Unknown\")\n```\n\n## Recommendation\nOption A is cleaner - sync state should be self-contained for orphan detection.\n\n## Migration\nOld sync state files won't have \"name\" key:\n- `prev_project.get(\"name\", \"Unknown\")` handles this gracefully\n- After one sync with new code, names will be stored\n\n## Test Plan\n1. Sync some projects (with fix)\n2. Check .sync-state.json includes \"name\" for each project\n3. Manually add fake project UUID to .sync-state.json with a name\n4. Run sync\n5. Verify orphaned project message shows the correct name\n\n## Before Closing\n- [ ] Add \"name\" to build_project_state() return dict\n- [ ] Verify orphaned project detection shows name\n- [ ] Test with manual .sync-state.json modification\n- [ ] git commit","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-07T15:16:50.768945+01:00","updated_at":"2025-12-07T15:26:54.621799+01:00","closed_at":"2025-12-07T15:26:54.621799+01:00","dependencies":[{"issue_id":"claude-sync-193","depends_on_id":"claude-sync-82p","type":"blocks","created_at":"2025-12-07T15:17:59.821864+01:00","created_by":"jason"}]}
{"id":"claude-sync-1j3","title":"Fix unsafe ISO timestamp string comparisons","description":"## Problem\nTimestamp comparisons use simple string equality, which breaks if API returns different timezone formats.\n\n## Location\nLines 805, 896:\n```python\nif current_updated \\!= prev_updated:  # String comparison\n    return True, f\"updated ({prev_updated[:10]} → {current_updated[:10]})\"\n```\n\n## The Risk\nISO 8601 timestamps can have equivalent but different string representations:\n- `2024-01-15T10:30:00Z`\n- `2024-01-15T10:30:00+00:00`\n- `2024-01-15T10:30:00.000Z`\n- `2024-01-15T10:30:00.000+00:00`\n\nAll represent the same moment, but string comparison fails.\n\n## Current Safety\nThe code consistently uses `datetime.now(timezone.utc).isoformat()` for local timestamps.\nAPI timestamps are stored as-is from API.\n\n**If API is consistent** (always same format), this works.\n**If API changes format** (e.g., after upgrade), all projects appear changed.\n\n## Robust Solution\n```python\nfrom datetime import datetime\n\ndef parse_timestamp(ts: str | None) -\u003e datetime | None:\n    \"\"\"Parse ISO timestamp, handling various formats.\"\"\"\n    if not ts:\n        return None\n    try:\n        # Try standard ISO format\n        return datetime.fromisoformat(ts.replace('Z', '+00:00'))\n    except ValueError:\n        return None\n\ndef timestamps_equal(ts1: str | None, ts2: str | None) -\u003e bool:\n    \"\"\"Compare timestamps for equality, handling format differences.\"\"\"\n    dt1 = parse_timestamp(ts1)\n    dt2 = parse_timestamp(ts2)\n    \n    if dt1 is None or dt2 is None:\n        # If either can't be parsed, fall back to string comparison\n        return ts1 == ts2\n    \n    return dt1 == dt2\n\n# Usage:\nif not timestamps_equal(current_updated, prev_updated):\n    return True, \"updated\"\n```\n\n## Alternative: Normalize on storage\n```python\ndef normalize_timestamp(ts: str | None) -\u003e str:\n    \"\"\"Normalize timestamp to consistent format for storage.\"\"\"\n    if not ts:\n        return \"\"\n    try:\n        dt = datetime.fromisoformat(ts.replace('Z', '+00:00'))\n        return dt.isoformat()  # Always same format\n    except ValueError:\n        return ts  # Return as-is if can't parse\n```\n\n## Gotchas\n- Millisecond precision: `.000` vs no milliseconds\n- Timezone indicator: `Z` vs `+00:00`\n- Some APIs return naive timestamps (no timezone) - treat as UTC?\n- Don't break existing comparisons that work\n\n## Test Plan\n1. Create .sync-state.json with timestamp `2024-01-15T10:30:00Z`\n2. Mock API to return `2024-01-15T10:30:00+00:00` (same time, different format)\n3. Run sync\n4. Verify project NOT detected as changed (after fix)\n5. Currently: would be detected as changed (false positive)\n\n## Before Closing\n- [ ] Add timestamp comparison helper\n- [ ] Update project_needs_sync() to use it\n- [ ] Update conversation_needs_sync() to use it\n- [ ] Test with different timestamp formats\n- [ ] git commit","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-07T15:17:45.099533+01:00","updated_at":"2025-12-07T17:13:20.196219+01:00","closed_at":"2025-12-07T17:13:20.196219+01:00"}
{"id":"claude-sync-2u0","title":"Document --include-standalone flag and feature","description":"The standalone conversations feature is completely undocumented.\n\nMissing documentation:\n- --include-standalone flag not in README.md CLI options table (lines 300-311)\n- No explanation of what standalone conversations are\n- No mention of _standalone/ output directory\n- Feature exists in code but users can't discover it\n\nFix:\n1. Add to README.md CLI options table:\n   | `--include-standalone` | `false` | Include standalone conversations (not in projects) |\n\n2. Add brief explanation of what standalone conversations are (conversations not associated with any project)\n\n3. Document _standalone/ directory in output structure\n\nIMPORTANT: Check ALL markdown files when updating:\n- README.md\n- CLAUDE.md  \n- docs/IMPLEMENTATION_NOTES.md","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-09T09:42:40.570991+01:00","updated_at":"2025-12-09T09:42:40.570991+01:00"}
{"id":"claude-sync-3do","title":"Refactor CLI to support subcommands (status, sync)","description":"Convert the current single-command CLI to a subcommand structure to support the new `status` command.\n\n## Current State\n\nThe CLI is a single typer command (`main`) that handles sync operations. The positional `org_uuid` argument makes it awkward to add new commands.\n\n## Required Changes\n\n1. Rename `main()` function to `sync()` and decorate as `@app.command()`\n2. Add `@app.callback(invoke_without_command=True)` for backward compatibility\n3. When no subcommand given, default to sync behavior\n4. Add skeleton `status` command\n\n## Acceptance Criteria\n\n- [ ] `claude_sync.py --help` shows both `sync` and `status` subcommands\n- [ ] `claude_sync.py status --help` shows status options\n- [ ] `claude_sync.py sync --help` shows sync options (same as current)\n- [ ] `claude_sync.py` (no args) still works as before (auto-discovers org, syncs)\n- [ ] `claude_sync.py \u003cuuid\u003e` still works (backward compat)\n- [ ] All existing sync options still work\n\n## Implementation Notes\n\nTyper subcommand pattern:\n```python\napp = typer.Typer()\n\n@app.command()\ndef sync(...): ...\n\n@app.command()\ndef status(...): ...\n\n@app.callback(invoke_without_command=True)\ndef main(ctx: typer.Context, ...):\n    if ctx.invoked_subcommand is None:\n        # Default to sync\n        sync(...)\n```\n\n## Testing\n\n```bash\n# These should all work:\n./claude_sync.py --help\n./claude_sync.py sync --help\n./claude_sync.py status --help\n./claude_sync.py  # should sync (if single org)\n./claude_sync.py \u003cuuid\u003e  # should sync specific org\n```\n\n## Files to Modify\n\n- `claude_sync.py`: Lines ~2068-2200 (CLI setup and main function)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-09T09:49:33.249767+01:00","updated_at":"2025-12-09T10:12:23.780851+01:00","closed_at":"2025-12-09T10:12:23.780851+01:00"}
{"id":"claude-sync-3ha","title":"Git Tracking for Sync Output","description":"Add automatic git tracking to the sync output directory for easy recovery and change history.\n\n## Goal\nMake synced data recoverable even if accidentally overwritten, and provide change history without needing to push to GitHub (data may be private).\n\n## Approach\n- Auto-initialize git repo in output directory if not exists\n- Auto-commit after each sync with timestamp\n- Local-only (no remote push)\n\n## Benefits\n- Easy recovery: git checkout to restore previous state\n- Change visibility: git diff to see what changed\n- No data loss: even if sync overwrites, history preserved\n\n## Implementation\nAfter sync completes:\n```python\ndef git_track(output_dir: Path):\n    if not (output_dir / '.git').exists():\n        subprocess.run(['git', 'init'], cwd=output_dir)\n        subprocess.run(['git', 'add', '.'], cwd=output_dir)\n        subprocess.run(['git', 'commit', '-m', 'Initial sync'], cwd=output_dir)\n    else:\n        subprocess.run(['git', 'add', '.'], cwd=output_dir)\n        # Only commit if changes exist\n        result = subprocess.run(['git', 'diff', '--staged', '--quiet'], cwd=output_dir)\n        if result.returncode != 0:\n            subprocess.run(['git', 'commit', '-m', f'Sync {datetime.now().isoformat()}'], cwd=output_dir)\n```\n\n## CLI Flag\n- --no-git: Disable git tracking (for testing or special cases)\n\n## Dependencies\n- Requires MVP complete","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-07T13:15:14.957464+01:00","updated_at":"2025-12-07T14:47:43.993607+01:00","closed_at":"2025-12-07T14:47:43.993607+01:00","dependencies":[{"issue_id":"claude-sync-3ha","depends_on_id":"claude-sync-8co","type":"blocks","created_at":"2025-12-07T13:15:14.958891+01:00","created_by":"jason"}]}
{"id":"claude-sync-3ha.1","title":"Implement auto git-init and commit","description":"Add git initialization and auto-commit:\n\n## Logic\n1. After sync completes, check if output_dir/.git exists\n2. If not, run git init\n3. Stage all files (git add .)\n4. Commit with descriptive message\n\n## Commit Message Format\n- Initial: 'Initial sync from claude.ai'\n- Updates: 'Sync update YYYY-MM-DD HH:MM:SS'\n\n## Only Commit if Changes\nCheck for staged changes before committing:\n```bash\ngit diff --staged --quiet\n# Exit code 0 = no changes, 1 = changes exist\n```\n\n## Error Handling\n- Git not installed: warn but don't fail\n- Permission errors: warn but don't fail\n- This is a convenience feature, not critical path","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-07T13:15:29.108845+01:00","updated_at":"2025-12-07T14:47:29.05733+01:00","closed_at":"2025-12-07T14:47:29.05733+01:00","dependencies":[{"issue_id":"claude-sync-3ha.1","depends_on_id":"claude-sync-3ha","type":"parent-child","created_at":"2025-12-07T13:15:29.109714+01:00","created_by":"jason"}]}
{"id":"claude-sync-3ha.2","title":"Add --no-git flag and test recovery workflow","description":"Add CLI flag to disable git tracking and test the recovery workflow:\n\n## CLI Addition\n--no-git: Skip git init/commit (useful for testing or if git not wanted)\n\n## Test Recovery Workflow\n1. Run initial sync\n2. Manually modify a CLAUDE.md file\n3. Run sync again (overwrites)\n4. Use git checkout to restore manual changes\n5. Document this in README\n\n## Verify\n- [ ] --no-git prevents any git operations\n- [ ] Recovery workflow works as expected\n- [ ] git log shows meaningful commit history","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-07T13:15:42.203037+01:00","updated_at":"2025-12-07T14:47:34.308074+01:00","closed_at":"2025-12-07T14:47:34.308074+01:00","dependencies":[{"issue_id":"claude-sync-3ha.2","depends_on_id":"claude-sync-3ha","type":"parent-child","created_at":"2025-12-07T13:15:42.20358+01:00","created_by":"jason"}]}
{"id":"claude-sync-3iq","title":"Sync standalone conversations (outside projects)","description":"Add support for syncing conversations that are not associated with any project.\n\n## Scope\nConversations created outside of projects (general Claude chats).\n\n## API Endpoint\n- GET /api/organizations/{org}/chat_conversations - All conversations\n- Filter out those already synced via projects\n\n## Output Structure\n```\n\u003coutput-dir\u003e/\n├── index.json\n├── \u003cproject-folders\u003e/\n└── _standalone/              # Special folder for non-project conversations\n    ├── index.json\n    └── \u003cconv-slug\u003e-\u003cuuid\u003e.json\n```\n\n## Considerations\n- May be many conversations (600+ in sample data)\n- Less organized than project conversations\n- Lower priority - project conversations are more valuable\n\n## CLI Flag\n--include-standalone: Include standalone conversations (off by default)\n\n## Dependencies\nRequires project-associated conversation sync working first.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-07T13:31:28.805592+01:00","updated_at":"2025-12-07T17:24:24.644366+01:00","closed_at":"2025-12-07T17:24:24.644366+01:00","dependencies":[{"issue_id":"claude-sync-3iq","depends_on_id":"claude-sync-8co.11","type":"blocks","created_at":"2025-12-07T13:31:28.806771+01:00","created_by":"jason"}]}
{"id":"claude-sync-3t6","title":"Fix critical documentation errors (wrong paths and dependencies)","description":"## Problem\nMultiple documentation files contain **wrong paths and dependencies** that will confuse users and break integrations.\n\n## Errors Found\n\n### 1. Output Directory Path (CRITICAL)\n\n| File | Line | Says | Should Say |\n|------|------|------|------------|\n| CLAUDE.md | ~17 | `~/.claude/synced-projects/` | `~/.local/share/claude-sync/` |\n| CLAUDE.md | ~40 | `configurable output location (default: ~/.claude/synced-projects/)` | `default: ~/.local/share/claude-sync/` |\n| IMPLEMENTATION_HANDOFF.md | ~29 | `~/.claude/synced-projects/` | `~/.local/share/claude-sync/` |\n| RESEARCH.md | ~187-195 | Architecture diagram shows wrong path | Update diagram |\n| RESEARCH.md | ~203-204 | Integration example `@~/.claude/synced-projects/...` | Wrong path |\n\n### 2. Dependencies (HIGH)\n\n| File | Line | Says | Should Say |\n|------|------|------|------------|\n| CLAUDE.md | ~17 | `requests - API calls` | `curl_cffi - API calls (Cloudflare bypass)` |\n| IMPLEMENTATION_HANDOFF.md | ~23 | `dependencies = [\"requests\u003c3\", ...]` | `dependencies = [\"curl_cffi\", ...]` |\n\n### 3. Outdated Status (MEDIUM)\n\n| File | Section | Says | Reality |\n|------|---------|------|---------|\n| IMPLEMENTATION_NOTES.md | Known Issues | \"Conversations not implemented\" | DONE - 1000+ LOC |\n| IMPLEMENTATION_NOTES.md | Known Issues | \"No incremental sync yet\" | DONE - fully implemented |\n| RESEARCH.md | Phase 1 checklist | Multiple items marked incomplete | Most are DONE |\n\n## Why This Matters\n- Users will look in wrong directory for synced projects\n- Copy-paste of dependency line will fail\n- Integration instructions won't work\n- New contributors will be confused\n\n## Implementation\nThis is a straightforward find-and-replace task. Key files to update:\n\n1. **CLAUDE.md**: Fix path and dependency\n2. **IMPLEMENTATION_HANDOFF.md**: Fix path and dependency\n3. **IMPLEMENTATION_NOTES.md**: Remove/update outdated status items\n4. **RESEARCH.md**: Fix path in diagram and examples\n\n## Verification\nAfter fixes, grep for old values:\n```bash\ngrep -r 'synced-projects' docs/ *.md\ngrep -r 'requests' CLAUDE.md IMPLEMENTATION_HANDOFF.md\n```\n\nShould return no matches (except in historical context).\n\n## Test Plan\n1. Read each file and verify paths match DEFAULT_OUTPUT_DIR in code (line 33)\n2. Verify dependency list matches script header (lines 2-5)\n3. Verify no claims of 'not implemented' for features that exist\n\n## Before Closing\n- [ ] Fix all path references\n- [ ] Fix all dependency references  \n- [ ] Update outdated status claims\n- [ ] Verify with grep\n- [ ] git commit docs changes","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-07T15:12:58.109361+01:00","updated_at":"2025-12-07T15:26:33.5018+01:00","closed_at":"2025-12-07T15:26:33.5018+01:00"}
{"id":"claude-sync-4qv","title":"Track failed projects in sync state for recovery","description":"When a project sync fails, it's excluded from index.json and state, making recovery difficult.\n\nCurrent behavior:\n- Project sync fails after partial write\n- Project excluded from synced_projects and new_state\n- Orphaned files persist\n- Next sync re-processes everything (no targeted retry)\n\nDesired behavior:\n- Track failed projects in state file with error info\n- Next sync can retry just failed projects\n- User can see which projects failed and why\n\nImplementation:\nnew_state['failed_projects'] = {\n    'uuid-123': {\n        'name': 'Project Name',\n        'error': 'Connection timeout',\n        'failed_at': '2025-12-09T...',\n        'partial_files': ['conversations/abc.md']\n    }\n}\n\nThis helps both humans and agents understand partial sync state.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-09T09:44:30.845601+01:00","updated_at":"2025-12-09T09:44:30.845601+01:00"}
{"id":"claude-sync-51g","title":"Document manual test results and update TESTING.md","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-07T15:46:48.159309+01:00","updated_at":"2025-12-07T16:58:48.94114+01:00","closed_at":"2025-12-07T16:58:48.94114+01:00"}
{"id":"claude-sync-53h","title":"Fix placeholder URL in README Quick Start","description":"README.md line 20 has placeholder that will break for users:\n\nCurrent:\ncurl -O https://raw.githubusercontent.com/yourusername/claude-sync/main/claude_sync.py\n\nProblem:\n- 'yourusername' is a placeholder, not actual repo path\n- Users who copy-paste will get 404\n- Repository should be portable - no hardcoded usernames\n\nFix:\n- Either use actual repo URL if public\n- Or remove the curl command and just reference cloning\n- Or use a generic instruction that doesn't assume specific GitHub path\n\nGoal: Repository should be portable with no personal identifiers hardcoded.","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-09T09:42:53.460224+01:00","updated_at":"2025-12-09T09:42:53.460224+01:00"}
{"id":"claude-sync-5a3","title":"Add high-value smoke and integration tests","description":"Add a small set of high-value tests. NOT a battery of trivial tests - quality over quantity.\n\nCRITICAL REQUIREMENTS:\n- Tests must NEVER threaten user data\n- Use isolated test directories (tempfile, pytest tmp_path)\n- Focus on preventing data loss scenarios\n\nHigh-value test areas:\n1. Filename sanitization (prevents path traversal attacks)\n2. Atomic write operations (prevents file corruption)\n3. State file round-trip (load/save preserves data)\n4. Lock file acquisition/release (prevents concurrent corruption)\n5. Smoke test: basic sync flow with mocked API\n\nWhat NOT to test:\n- Trivial getters/setters\n- Exhaustive edge cases for simple functions\n- Anything that requires real API calls (too fragile)\n\nUse pytest. Keep tests fast (\u003c5s total).","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-09T09:41:59.617239+01:00","updated_at":"2025-12-09T09:41:59.617239+01:00","dependencies":[{"issue_id":"claude-sync-5a3","depends_on_id":"claude-sync-fri","type":"blocks","created_at":"2025-12-09T09:41:59.618667+01:00","created_by":"jason"}]}
{"id":"claude-sync-655","title":"CRITICAL: Conversation changes not detected independently","description":"","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-07T15:45:32.132993+01:00","updated_at":"2025-12-07T16:47:07.990925+01:00","closed_at":"2025-12-07T16:47:07.990925+01:00"}
{"id":"claude-sync-67b","title":"Conversation index.json not written atomically","description":"Line 1272: write_conversation_index() uses write_text() instead of atomic_write_json(). Unlike index.json and .sync-state.json which use atomic_write_json(), conversation index could be corrupted if interrupted mid-write. Fix: Change to use atomic_write_json() helper.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-07T17:13:55.410964+01:00","updated_at":"2025-12-07T17:20:59.403077+01:00","closed_at":"2025-12-07T17:20:59.403077+01:00"}
{"id":"claude-sync-6bp","title":"Implement incremental conversation sync","description":"**Original task**: claude-sync-8co.11 (partially implemented)\n\n**What was missing**: No incremental sync for conversations - always re-fetches all.\n\n## Required Implementation\n1. Store conversation state in .sync-state.json per project:\n```json\n{\n  \"projects\": {\n    \"\u003cproject-uuid\u003e\": {\n      \"conversations\": {\n        \"\u003cconvo-uuid\u003e\": {\n          \"updated_at\": \"2025-12-07T...\",\n          \"message_count\": 15\n        }\n      }\n    }\n  }\n}\n```\n\n2. Compare conversation updated_at with stored value\n3. Only fetch full conversation if updated_at changed\n4. Skip unchanged conversations\n\n## Detection Logic\n```python\ndef conversation_needs_sync(convo_meta: dict, prev_state: dict) -\u003e tuple[bool, str]:\n    prev_convo = prev_state.get('conversations', {}).get(convo_meta['uuid'])\n    if not prev_convo:\n        return True, \"new\"\n    if convo_meta['updated_at'] != prev_convo['updated_at']:\n        return True, \"updated\"\n    return False, \"unchanged\"\n```\n\n## Test Plan\n1. Sync project with conversations\n2. Run sync again - should skip all conversations\n3. Verify log shows \"X conversations skipped\"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T14:59:50.648652+01:00","updated_at":"2025-12-07T15:10:29.624701+01:00","closed_at":"2025-12-07T15:10:29.624701+01:00"}
{"id":"claude-sync-79x","title":"Add content size limits to prevent memory exhaustion","description":"## Problem\nNo validation of content size from API. A malicious or buggy API response with 2GB document content would:\n- Fill memory\n- Fill disk\n- Potentially crash system\n\n## Current Code\nLines 670-672:\n```python\ndoc_content = doc.get(\"content\", \"\")  # No size check\\!\ndoc_path = docs_dir / unique_filename\ndoc_path.write_text(doc_content, encoding=\"utf-8\")\n```\n\nSimilarly for conversations at line 1011.\n\n## Implementation\n\n### Add size constants\n```python\n# Maximum sizes (configurable)\nMAX_DOC_SIZE_MB = 10\nMAX_CONVERSATION_SIZE_MB = 50\nMAX_PROJECT_TOTAL_MB = 100\n```\n\n### Validate before write\n```python\ndef validate_content_size(content: str, max_mb: int, context: str) -\u003e None:\n    \"\"\"Raise if content exceeds size limit.\"\"\"\n    size_bytes = len(content.encode('utf-8'))\n    size_mb = size_bytes / (1024 * 1024)\n    \n    if size_mb \u003e max_mb:\n        raise ValueError(\n            f\"{context} exceeds size limit: {size_mb:.1f}MB \u003e {max_mb}MB. \"\n            f\"Skipping to prevent resource exhaustion.\"\n        )\n\n# Usage in write_project_output:\nfor doc in docs:\n    doc_content = doc.get(\"content\", \"\")\n    try:\n        validate_content_size(doc_content, MAX_DOC_SIZE_MB, f\"Document '{doc_filename}'\")\n    except ValueError as e:\n        log.warning(str(e))\n        continue  # Skip oversized doc\n    \n    doc_path.write_text(doc_content, encoding=\"utf-8\")\n```\n\n### CLI override (optional)\n```python\nparser.add_argument(\n    \"--max-doc-mb\",\n    type=int,\n    default=10,\n    help=\"Maximum document size in MB (default: 10)\"\n)\n```\n\n## Gotchas\n- **Don't fail entire sync** for one oversized doc - log warning and skip\n- **Track skipped docs** in index for visibility\n- Consider: streaming writes for large content (future enhancement)\n- len(str) gives chars, need encode() for byte size\n\n## What to Limit\n| Content Type | Default Limit | Rationale |\n|--------------|---------------|-----------|\n| Single document | 10 MB | Docs should be text, not binary |\n| Single conversation | 50 MB | Long convos exist, be generous |\n| Project total | 100 MB | Reasonable for text project |\n| All projects total | 1 GB | Sanity check |\n\n## Test Plan\n1. Create mock doc with 15MB content\n2. Run sync\n3. Verify:\n   - Warning logged about oversized doc\n   - Doc NOT written to disk\n   - Other docs still synced\n   - Index shows doc was skipped (optional)\n\n## Before Closing\n- [ ] Add size validation function\n- [ ] Add to doc writing loop\n- [ ] Add to conversation writing\n- [ ] Add CLI override options (optional)\n- [ ] Test with oversized mock content\n- [ ] git commit","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-07T15:17:14.263158+01:00","updated_at":"2025-12-07T17:13:25.436397+01:00","closed_at":"2025-12-07T17:13:25.436397+01:00"}
{"id":"claude-sync-7gv","title":"Migrate CLI from argparse to typer","description":"","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-07T16:52:39.662888+01:00","updated_at":"2025-12-07T17:24:29.901801+01:00","closed_at":"2025-12-07T17:24:29.901801+01:00"}
{"id":"claude-sync-82p","title":"Detect deleted projects and mark as orphaned","description":"**Original task**: claude-sync-bkw.2 (partially implemented)\n\n**What was missing**: The change detection logic doesn't handle deleted projects.\n\n## Required Implementation\nWhen a project exists in local sync state but not in API response:\n1. Mark project as 'orphaned' in index.json\n2. Keep local files (don't delete - safety first)\n3. Log warning about orphaned project\n\n```python\ndef detect_deleted_projects(prev_state: dict, current_projects: list) -\u003e list[str]:\n    \"\"\"Return list of project UUIDs that were deleted remotely.\"\"\"\n    current_uuids = {p['uuid'] for p in current_projects}\n    prev_uuids = set(prev_state.get('projects', {}).keys())\n    return list(prev_uuids - current_uuids)\n```\n\n## Index.json Update\nAdd 'orphaned' field:\n```json\n{\n  \"projects\": {\n    \"\u003cuuid\u003e\": {\n      \"name\": \"...\",\n      \"orphaned\": true,\n      \"orphaned_at\": \"2025-12-07T...\"\n    }\n  }\n}\n```\n\n## Test Plan\n1. Sync with all projects\n2. Manually add fake project to .sync-state.json\n3. Run sync again\n4. Verify orphaned project is logged and marked","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T14:54:23.667642+01:00","updated_at":"2025-12-07T15:10:34.881297+01:00","closed_at":"2025-12-07T15:10:34.881297+01:00"}
{"id":"claude-sync-84p","title":"Documentation and Claude Code Integration","description":"Create comprehensive documentation and Claude Code integration helpers.\n\n## Goal\nMake the tool easy to use for anyone, with clear instructions for Claude Code integration.\n\n## Deliverables\n1. README.md with:\n   - Quick start guide\n   - How to find your org UUID\n   - Output structure explanation\n   - Claude Code integration instructions\n\n2. .claude/commands/setup-sync.md\n   - Idempotent setup command\n   - Helps user configure CLAUDE.md imports\n   - Can be run multiple times safely\n\n## Integration Pattern\nUser adds to their ~/.claude/CLAUDE.md:\n```markdown\n# Synced Web App Projects\n@~/.claude/synced-projects/project-a/CLAUDE.md\n@~/.claude/synced-projects/project-b/CLAUDE.md\n```\n\n## User-Agnostic\n- No hardcoded paths in docs\n- Use ~ or environment variables\n- Works on Mac/Linux (Windows is stretch goal)","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-07T13:16:56.706093+01:00","updated_at":"2025-12-07T17:07:02.506141+01:00","closed_at":"2025-12-07T17:07:02.506141+01:00","dependencies":[{"issue_id":"claude-sync-84p","depends_on_id":"claude-sync-8co","type":"blocks","created_at":"2025-12-07T13:16:56.707319+01:00","created_by":"jason"},{"issue_id":"claude-sync-84p","depends_on_id":"claude-sync-bkw","type":"blocks","created_at":"2025-12-07T13:16:56.708248+01:00","created_by":"jason"}]}
{"id":"claude-sync-84p.1","title":"Write README.md","description":"Create comprehensive README:\n\n## Sections\n1. **Overview** - What this tool does\n2. **Quick Start** - 3-step guide\n3. **Installation** - Just download the script\n4. **Finding Your Org UUID** - With screenshots/steps\n5. **Usage Examples** - Common commands\n6. **Output Structure** - What gets created where\n7. **Claude Code Integration** - How to use synced content\n8. **Configuration** - All CLI flags\n9. **Troubleshooting** - Common issues\n\n## Key Points\n- Emphasize single-file, no install needed\n- Show how to make script executable\n- Explain the default output location\n- Link to gist for updates","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-07T13:17:09.589095+01:00","updated_at":"2025-12-07T17:06:01.839176+01:00","closed_at":"2025-12-07T17:06:01.839176+01:00","dependencies":[{"issue_id":"claude-sync-84p.1","depends_on_id":"claude-sync-84p","type":"parent-child","created_at":"2025-12-07T13:17:09.589744+01:00","created_by":"jason"}]}
{"id":"claude-sync-84p.2","title":"Create /setup-sync command","description":"Create a Claude Code slash command to help users integrate synced projects:\n\n## File: .claude/commands/setup-sync.md\n\n## What It Does\n1. Check if synced projects exist at default location\n2. List available projects\n3. Offer to add @imports to user's CLAUDE.md\n4. Idempotent - safe to run multiple times\n\n## Prompt Content\n```markdown\nHelp the user integrate their synced Claude web app projects with Claude Code.\n\n1. Check if ~/.claude/synced-projects/ exists\n2. If yes, list the projects found\n3. Suggest adding imports to ~/.claude/CLAUDE.md like:\n   @~/.claude/synced-projects/project-name/CLAUDE.md\n4. If already integrated, confirm everything looks good\n\nBe helpful and explain what each step does.\n```\n\n## Idempotent Behavior\n- Check if imports already exist before adding\n- Don't duplicate imports\n- Inform user of current state","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-07T13:17:23.643139+01:00","updated_at":"2025-12-07T17:06:17.682732+01:00","closed_at":"2025-12-07T17:06:17.682732+01:00","dependencies":[{"issue_id":"claude-sync-84p.2","depends_on_id":"claude-sync-84p","type":"parent-child","created_at":"2025-12-07T13:17:23.643766+01:00","created_by":"jason"}]}
{"id":"claude-sync-8co","title":"MVP: Fetch \u0026 Organize","description":"Core functionality to fetch Claude web app projects and organize them into a local directory structure suitable for Claude Code integration.\n\n## Goal\nGet web app project content into Claude Code-friendly local structure with a single command.\n\n## Output Structure\n```\n\u003coutput-dir\u003e/\n├── index.json              # Manifest with sync metadata\n└── \u003cproject-slug\u003e/\n    ├── CLAUDE.md           # From prompt_template\n    ├── meta.json           # Project metadata\n    └── docs/               # Project documents\n```\n\n## Key Requirements\n- Single UV script with inline dependencies\n- Browser cookie extraction (Edge/Chrome via browser-cookie3)\n- Configurable output directory (default: ~/.claude/synced-projects/)\n- Robust filename sanitization (cross-platform)\n- User-agnostic (no hardcoded paths)\n- Progress display with tqdm\n\n## API Endpoints Used\n- GET /api/organizations/{org}/projects\n- GET /api/organizations/{org}/projects/{pid}\n- GET /api/organizations/{org}/projects/{pid}/docs?tree=true\n\n## Gotchas to Watch For\n- Forward slashes in doc titles break filenames\n- Session keys expire frequently\n- Need to handle all invalid filename chars: \u003c\u003e:\"/\\|?*\n- Windows reserved names (CON, PRN, etc.)\n\n## Success Criteria\n- Can run: ./claude_sync.py \u003corg-id\u003e -o \u003coutput-dir\u003e\n- Output is browsable directory structure\n- Project instructions become CLAUDE.md files\n- All docs preserved with safe filenames","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-07T13:12:17.748215+01:00","updated_at":"2025-12-07T14:26:25.224773+01:00","closed_at":"2025-12-07T14:26:25.224773+01:00"}
{"id":"claude-sync-8co.10","title":"Handle partial sync failures gracefully","description":"Ensure sync failures don't leave corrupted/inconsistent state:\n\n## Problem\nIf sync fails mid-way (network error, session expiry), we could have:\n- Some projects synced, others not\n- Partial project directory (some docs written, others not)\n- index.json inconsistent with actual files\n\n## ⚠️ MEDIUM RISK - Data Consistency\n\n### Strategy: Atomic-ish Writes\n\n**Option A: Write to temp, rename on success**\n```python\ndef sync_project(project, output_dir):\n    temp_dir = output_dir / f'.tmp_{project[\"uuid\"]}'\n    try:\n        # Write all files to temp\n        write_project_to_dir(project, temp_dir)\n        # Atomic rename\n        final_dir = output_dir / slugify(project['name'])\n        if final_dir.exists():\n            shutil.rmtree(final_dir)\n        temp_dir.rename(final_dir)\n    finally:\n        if temp_dir.exists():\n            shutil.rmtree(temp_dir)\n```\n\n**Option B: Track progress, resume on retry (more complex)**\n- Store 'last_successful_project' in index.json\n- On retry, skip already-synced projects\n\n### Recommendation\nStart with Option A (simpler). If sync fails:\n- Partially synced project is cleaned up\n- Successfully synced projects remain\n- User re-runs to complete\n\n### index.json Consistency\nWrite index.json LAST, after all projects synced:\n```python\ndef sync_all(projects, output_dir):\n    results = {}\n    for project in projects:\n        try:\n            sync_project(project, output_dir)\n            results[project['uuid']] = {...}\n        except Exception as e:\n            print(f'Failed to sync {project[\"name\"]}: {e}')\n            # Continue with next project\n    \n    # Write index only with successful projects\n    write_index(output_dir, results)\n```\n\n## Error Reporting\nOn partial failure:\n- List which projects succeeded\n- List which failed with reasons\n- Exit with non-zero code if any failures","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T13:21:08.595326+01:00","updated_at":"2025-12-07T17:13:14.946807+01:00","closed_at":"2025-12-07T17:13:14.946807+01:00","dependencies":[{"issue_id":"claude-sync-8co.10","depends_on_id":"claude-sync-8co","type":"parent-child","created_at":"2025-12-07T13:21:08.595927+01:00","created_by":"jason"},{"issue_id":"claude-sync-8co.10","depends_on_id":"claude-sync-l4u","type":"blocks","created_at":"2025-12-07T15:50:29.310252+01:00","created_by":"jason"}]}
{"id":"claude-sync-8co.11","title":"Sync project-associated conversations","description":"Add conversation syncing for project-associated conversations:\n\n## Scope\nSync conversations that belong to a project (via project UUID association).\n\n## API Endpoint\n- GET /api/organizations/{org}/projects/{pid}/conversations?tree=true - List conversations\n- GET /api/organizations/{org}/chat_conversations/{cid}?rendering_mode=messages\u0026render_all_tools=true - Full conversation\n\n## Output Structure\n```\n\u003cproject-slug\u003e/\n├── CLAUDE.md\n├── meta.json\n├── docs/\n└── conversations/\n    ├── index.json           # Conversation list with metadata\n    └── \u003cconv-slug\u003e-\u003cuuid\u003e.json  # Full conversation\n```\n\n## Conversation JSON Format\n```json\n{\n  \"uuid\": \"...\",\n  \"name\": \"Conversation Title\",\n  \"created_at\": \"...\",\n  \"updated_at\": \"...\",\n  \"messages\": [\n    {\"role\": \"human\", \"text\": \"...\", \"created_at\": \"...\"},\n    {\"role\": \"assistant\", \"text\": \"...\", \"created_at\": \"...\"}\n  ]\n}\n```\n\n## Incremental Sync Support\n- Conversations have updated_at - can detect changes\n- Store last sync timestamp per conversation\n- Only re-fetch if updated_at \u003e last_synced\n\n## CLI Flag\n--skip-conversations: Skip conversation sync (for faster project-only sync)\nDefault: sync conversations\n\n## Performance Note\nMany API calls (1 per conversation). Consider:\n- Progress bar per project showing conversation count\n- Small delay between requests to avoid rate limits","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T13:31:14.212424+01:00","updated_at":"2025-12-07T14:47:23.799568+01:00","closed_at":"2025-12-07T14:47:23.799568+01:00","dependencies":[{"issue_id":"claude-sync-8co.11","depends_on_id":"claude-sync-8co","type":"parent-child","created_at":"2025-12-07T13:31:14.213217+01:00","created_by":"jason"}]}
{"id":"claude-sync-8co.3","title":"Set up script skeleton with UV shebang","description":"Create the initial claude_sync.py with:\n- UV run shebang: #!/usr/bin/env -S uv run --script\n- Inline dependency metadata (script section)\n- Required deps: requests, tqdm, browser-cookie3\n- Basic argparse CLI structure\n- Main function skeleton\n\nReference the gist structure: https://gist.github.com/jas-ho/f95abd89d4e007eac9ee821d7c2a3d0b","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T13:13:29.865749+01:00","updated_at":"2025-12-07T14:00:17.554262+01:00","closed_at":"2025-12-07T14:00:17.554262+01:00","dependencies":[{"issue_id":"claude-sync-8co.3","depends_on_id":"claude-sync-8co","type":"parent-child","created_at":"2025-12-07T13:13:29.866631+01:00","created_by":"jason"}]}
{"id":"claude-sync-8co.4","title":"Implement browser cookie extraction","description":"Implement cookie extraction from browser:\n\n## Requirements\n- Extract sessionKey and cf_clearance cookies from Edge/Chrome\n- Use browser-cookie3 library\n- Support --browser flag (edge/chrome/auto)\n- Clear error message if cookies missing or expired\n\n## Code Pattern (from gist)\n```python\ndef load_cookies(domain: str = 'claude.ai', browser: str = 'edge'):\n    cj = browser_cookie3.edge(domain_name=domain) if browser == 'edge' else browser_cookie3.load(domain_name=domain)\n    need = {'sessionKey', 'cf_clearance'}\n    got = {c.name for c in cj}\n    missing = need - got\n    if missing:\n        sys.exit(f'Missing cookie(s): {missing}. Log into Claude in browser, then rerun.')\n    return cj\n```\n\n## ⚠️ HIGH RISK - Known Issues\n\n### macOS Keychain (Chrome)\nbrowser-cookie3 often fails to access Chrome cookies on macOS due to Keychain permissions.\n**Workaround**: Try Edge first (default), or use --browser chrome with browser fully closed.\n**Fallback**: May need manual cookie extraction instructions in README.\n\n### Browser Must Be Closed\nOn some systems, cookies are locked while browser is open.\n**Mitigation**: Clear error message: 'Close your browser and retry'\n\n### Session Expiration\nsessionKey expires frequently (hours, not days).\n**Mitigation**: \n- Check for 401/403 responses in API client\n- Clear message: 'Session expired. Re-login to Claude.ai and retry'\n\n### Firefox/Safari Not Supported\nbrowser-cookie3 doesn't reliably support these.\n**Mitigation**: Document in README, suggest Edge/Chrome.\n\n### Multiple Profiles\nIf user has multiple browser profiles, may get wrong cookies.\n**Mitigation**: Document which profile needs to be logged in.\n\n## Testing Checklist\n- [ ] Works with Edge on macOS\n- [ ] Works with Chrome on macOS (browser closed)\n- [ ] Clear error if browser open\n- [ ] Clear error if not logged in\n- [ ] Clear error if session expired","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T13:13:44.376107+01:00","updated_at":"2025-12-07T14:01:29.813024+01:00","closed_at":"2025-12-07T14:01:29.813024+01:00","dependencies":[{"issue_id":"claude-sync-8co.4","depends_on_id":"claude-sync-8co","type":"parent-child","created_at":"2025-12-07T13:13:44.377067+01:00","created_by":"jason"}]}
{"id":"claude-sync-8co.5","title":"Implement API client for Claude.ai","description":"Implement API client to fetch data from Claude.ai:\n\n## Endpoints\n- GET /api/organizations/{org}/projects - List all projects\n- GET /api/organizations/{org}/projects/{pid} - Project metadata + prompt_template\n- GET /api/organizations/{org}/projects/{pid}/docs?tree=true - Project documents\n\n## Requirements\n- Use requests library with session\n- Set proper headers (User-Agent, Accept, Referer, Origin)\n- Handle 404 (FileNotFoundError) and other HTTP errors gracefully\n- Timeout handling (30s default)\n\n## Headers Pattern\n```python\nHEADERS = {\n    'User-Agent': 'Mozilla/5.0 ...',\n    'Accept': 'application/json, text/plain, */*',\n    'Referer': 'https://claude.ai/',\n    'Origin': 'https://claude.ai',\n}\n```\n\n## ⚠️ MEDIUM RISK - API Instability\n\n### Undocumented API\nThis is Claude's internal web API, not a public API.\n- Endpoints could change without notice\n- Response format could change\n- Could get blocked as bot traffic\n\n**Mitigation**:\n- Use realistic browser User-Agent\n- Add small delays between requests (0.1-0.5s)\n- Handle unexpected response formats gracefully\n- Log raw responses on error for debugging\n\n### Rate Limiting (Unknown)\nNo documentation on rate limits for internal API.\n\n**Mitigation**:\n- Don't parallelize aggressively (unlike gist's MAX_WORKERS=16)\n- Start conservative: sequential requests with small delays\n- Add --parallel flag later if needed\n\n### Session Expiration Mid-Sync\nFor large orgs, session might expire during sync.\n\n**Mitigation**:\n- Check for 401/403 after each request\n- Fail fast with clear message rather than partial corrupt state\n\n## Error Handling\n- 401/403: 'Session expired or invalid. Re-login to Claude.ai'\n- 404: Raise FileNotFoundError (project/doc deleted)\n- 429: 'Rate limited. Wait and retry.' (if we see this)\n- 5xx: 'Claude.ai server error. Try again later.'\n- Timeout: 'Request timed out. Check connection.'\n\n## Retry Logic\nConsider simple retry for transient failures:\n```python\nfor attempt in range(3):\n    try:\n        return fetch(url)\n    except (Timeout, ConnectionError):\n        if attempt == 2: raise\n        time.sleep(1)\n```","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T13:13:58.502506+01:00","updated_at":"2025-12-07T14:08:30.613908+01:00","closed_at":"2025-12-07T14:08:30.613908+01:00","dependencies":[{"issue_id":"claude-sync-8co.5","depends_on_id":"claude-sync-8co","type":"parent-child","created_at":"2025-12-07T13:13:58.503307+01:00","created_by":"jason"}]}
{"id":"claude-sync-8co.6","title":"Implement robust filename sanitization","description":"Implement cross-platform filename sanitization:\n\n## Invalid Characters to Handle\n- Forward slash /\n- Backslash \\\\\n- Colon :\n- Asterisk *\n- Question mark ?\n- Double quotes \"\n- Angle brackets \u003c \u003e\n- Pipe |\n- NULL bytes\n- Control characters (0x00-0x1F)\n\n## Platform-Specific\n- Windows reserved names: CON, PRN, AUX, NUL, COM1-9, LPT1-9\n- Leading/trailing spaces and dots (Windows issue)\n- Max filename length (~255 chars)\n\n## ⚠️ MEDIUM RISK - Collision \u0026 Unicode Issues\n\n### Filename Collisions After Sanitization\nTwo docs: 'Guide: Part 1' and 'Guide/ Part 1' both become 'Guide- Part 1'\n\n**Mitigation**:\n```python\ndef get_unique_filename(base: str, existing: set) -\u003e str:\n    if base not in existing:\n        return base\n    for i in range(1, 1000):\n        candidate = f'{base[:-3]}_{i}.md'\n        if candidate not in existing:\n            return candidate\n    raise ValueError(f'Too many collisions for {base}')\n```\n\n### macOS Case Insensitivity\nHFS+ treats 'Guide.md' and 'guide.md' as same file.\n\n**Mitigation**: \n- Normalize to lowercase for collision checking\n- Or track case-insensitive set of used names\n\n### Unicode Normalization\nmacOS uses NFD, others use NFC. 'é' can be 1 or 2 codepoints.\n\n**Mitigation**:\n```python\nimport unicodedata\nname = unicodedata.normalize('NFC', name)\n```\n\n### Emoji in Filenames\nGenerally works but can cause issues on older systems.\n\n**Mitigation**: Consider stripping or replacing emoji (optional).\n\n## Implementation\n```python\nimport unicodedata\nimport re\n\nINVALID_CHARS = r'[\u003c\u003e:\"/\\\\|?*\\x00-\\x1f]'\nWINDOWS_RESERVED = {'CON', 'PRN', 'AUX', 'NUL'} | {f'{p}{i}' for p in ['COM', 'LPT'] for i in range(1,10)}\n\ndef sanitize_filename(name: str, max_len: int = 200) -\u003e str:\n    # Normalize unicode\n    name = unicodedata.normalize('NFC', name)\n    # Remove/replace invalid chars\n    name = re.sub(INVALID_CHARS, '-', name)\n    # Handle Windows reserved\n    stem = name.rsplit('.', 1)[0].upper()\n    if stem in WINDOWS_RESERVED:\n        name = f'_{name}'\n    # Strip leading/trailing spaces and dots\n    name = name.strip(' .')\n    # Truncate\n    if len(name) \u003e max_len:\n        name = name[:max_len-10] + '_' + hashlib.md5(name.encode()).hexdigest()[:8]\n    # Ensure non-empty\n    return name or 'unnamed'\n```\n\n## Test Cases\n- 'My Doc / Part 1' -\u003e 'My Doc - Part 1'\n- 'File: Important' -\u003e 'File- Important'\n- 'CON' -\u003e '_CON'\n- 'Guide.md' vs 'guide.md' -\u003e collision handled\n- Very long names -\u003e truncated with hash\n- 'naïve' (NFD) -\u003e 'naïve' (NFC)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T13:14:13.517995+01:00","updated_at":"2025-12-07T14:10:17.831537+01:00","closed_at":"2025-12-07T14:10:17.831537+01:00","dependencies":[{"issue_id":"claude-sync-8co.6","depends_on_id":"claude-sync-8co","type":"parent-child","created_at":"2025-12-07T13:14:13.518811+01:00","created_by":"jason"}]}
{"id":"claude-sync-8co.7","title":"Implement directory output structure","description":"Create the output directory structure:\n\n## Structure\n```\n\u003coutput-dir\u003e/\n├── index.json              # Manifest with sync metadata\n└── \u003cproject-slug\u003e-\u003cuuid\u003e/\n    ├── CLAUDE.md           # From prompt_template (project instructions)\n    ├── meta.json           # Full project metadata\n    └── docs/\n        ├── doc1.md\n        └── doc2.md\n```\n\n## index.json Format\n```json\n{\n  \"synced_at\": \"2025-01-15T10:30:00Z\",\n  \"org_id\": \"uuid\",\n  \"projects\": {\n    \"uuid-1\": {\n      \"name\": \"Project Name\",\n      \"slug\": \"project-name\",\n      \"path\": \"project-name-uuid/\",\n      \"updated_at\": \"...\",\n      \"docs_count\": 5\n    }\n  }\n}\n```\n\n## CLAUDE.md Generation\n- Copy prompt_template content directly\n- Add frontmatter with metadata (synced_at, source URL)\n- If no prompt_template, create minimal CLAUDE.md with project name\n\n## Overwrite Behavior\n- Overwrite existing files (MVP, no merge logic yet)\n- Create directories if they don't exist","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T13:14:29.001944+01:00","updated_at":"2025-12-07T14:14:02.400484+01:00","closed_at":"2025-12-07T14:14:02.400484+01:00","dependencies":[{"issue_id":"claude-sync-8co.7","depends_on_id":"claude-sync-8co","type":"parent-child","created_at":"2025-12-07T13:14:29.003024+01:00","created_by":"jason"}]}
{"id":"claude-sync-8co.8","title":"Add CLI interface with argparse","description":"Implement CLI interface:\n\n## Usage\n```bash\n./claude_sync.py \u003cORG_UUID\u003e                    # Sync to default location\n./claude_sync.py \u003cORG_UUID\u003e -o \u003coutput-dir\u003e    # Custom output\n./claude_sync.py \u003cORG_UUID\u003e --browser chrome   # Use Chrome cookies\n./claude_sync.py --help                        # Show help\n```\n\n## Arguments\n- org (positional, required): Organization UUID\n- -o, --output: Output directory (default: ~/.claude/synced-projects/)\n- --browser: Browser for cookies (edge/chrome/auto, default: auto)\n- --verbose: Enable debug logging\n- --dry-run: Show what would be synced without writing\n\n## ⚠️ USER FRICTION - Org UUID Discovery\n\nUsers won't know their org UUID. Need clear instructions.\n\n### How to Find Org UUID\n1. Open Claude.ai, log in\n2. Open DevTools (F12) \u003e Network tab\n3. Refresh page or click on a project\n4. Filter requests for 'organizations'\n5. Look at request URL: /api/organizations/\u003cUUID\u003e/...\n6. Copy the UUID\n\n### Alternative: Auto-Discovery (Nice to Have)\nCould fetch from /api/bootstrap endpoint which returns user's orgs.\n```python\ndef discover_org():\n    resp = fetch('/api/bootstrap')\n    orgs = resp.get('organizations', [])\n    if len(orgs) == 1:\n        return orgs[0]['uuid']\n    elif len(orgs) \u003e 1:\n        print('Multiple orgs found. Please specify:')\n        for org in orgs:\n            print(f'  {org[\"uuid\"]}: {org[\"name\"]}')\n        sys.exit(1)\n```\n\nConsider adding --discover flag or making org optional if we implement this.\n\n## Exit Codes\n- 0: Success (all projects synced)\n- 1: Partial failure (some projects failed)\n- 2: Fatal error (auth, network, etc.)\n\n## Help Text\nInclude in --help:\n- How to find org UUID\n- Default output location\n- Example usage\n- Link to README for more info","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T13:14:43.550462+01:00","updated_at":"2025-12-07T14:17:27.182191+01:00","closed_at":"2025-12-07T14:17:27.182191+01:00","dependencies":[{"issue_id":"claude-sync-8co.8","depends_on_id":"claude-sync-8co","type":"parent-child","created_at":"2025-12-07T13:14:43.551154+01:00","created_by":"jason"}]}
{"id":"claude-sync-8co.9","title":"Test with real data and sanity check","description":"Test the MVP implementation with real data:\n\n## Test Plan\n1. Run against your org with ~13 projects\n2. Verify all projects synced\n3. Check CLAUDE.md files have correct content\n4. Verify docs are readable and correctly named\n5. Check filenames for special characters handled correctly\n\n## Sanity Checks\n- [ ] All project names appear in index.json\n- [ ] CLAUDE.md matches prompt_template from web UI\n- [ ] Doc count matches what's visible in web app\n- [ ] No crashes on edge case filenames\n- [ ] Output is git-trackable (no binary artifacts)\n\n## Red Team / Edge Cases\n- Project with no prompt_template\n- Project with no docs\n- Doc with forward slash in title\n- Doc with very long name\n- Doc with unicode characters\n- Empty project\n\n## Performance Check\n- Full sync should complete in \u003c 2 minutes for ~15 projects\n- Progress bar should show meaningful updates","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T13:14:58.227776+01:00","updated_at":"2025-12-07T14:21:23.979131+01:00","closed_at":"2025-12-07T14:21:23.979131+01:00","dependencies":[{"issue_id":"claude-sync-8co.9","depends_on_id":"claude-sync-8co","type":"parent-child","created_at":"2025-12-07T13:14:58.228649+01:00","created_by":"jason"}]}
{"id":"claude-sync-8dh","title":"Update CLAUDE.md with missing output structure","description":"CLAUDE.md output structure is incomplete. Update to match actual implementation.\n\nCurrently missing from CLAUDE.md:\n- conversations/ directory in project structure  \n- .backup/ directory at root\n- _standalone/ directory at root\n- .sync-state.json file\n- .git/ directory\n\nIMPORTANT: When updating documentation:\n- Check ALL markdown files for consistency\n- Files to check: CLAUDE.md, README.md, docs/IMPLEMENTATION_NOTES.md\n- Ensure terminology is consistent across all docs\n- This is an EARLY update - a final docs review will happen at the end\n\nThis is part 1 of 2 documentation updates (early sync of critical info).","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-09T09:42:27.459919+01:00","updated_at":"2025-12-09T09:42:27.459919+01:00"}
{"id":"claude-sync-9g7","title":"Fix path traversal vulnerability in conversation deletion","description":"CRITICAL SECURITY: prev_filename from state file is not validated before deletion.\n\nLocation: sync() function, conversation deletion logic (lines ~1866-1869)\n\nProblem:\n- prev_filename comes from previously-saved state JSON\n- If state file is manually edited or corrupted, could contain '../../../important_file.md'\n- Code does: old_file = project_dir / 'conversations' / prev_filename\n- Then old_file.unlink() - deletes arbitrary files!\n\nFix:\n- Validate that resolved path stays within conversations/ directory\n- Use Path.resolve() and check it starts with expected parent\n- Example: if not old_file.resolve().is_relative_to(project_dir / 'conversations'): log warning and skip\n\nThis is a data loss vector - highest priority.","status":"open","priority":0,"issue_type":"bug","created_at":"2025-12-09T09:41:32.845227+01:00","updated_at":"2025-12-09T09:41:32.845227+01:00"}
{"id":"claude-sync-ab2","title":"Add sync metrics logging","description":"**Original task**: claude-sync-bkw.3 (partially implemented)\n\n**What was missing**: No metrics logging during sync.\n\n## Required Implementation\nLog metrics at end of sync:\n- Projects checked: N\n- Projects synced: M (new + modified)\n- Projects skipped: K (unchanged)\n- Projects orphaned: O (deleted remotely)\n- Conversations synced: C (if enabled)\n- Time taken: X.Xs\n- Estimated data: ~X KB\n\n## Output Format\n```\nSync complete in 18.3s\n  Projects: 16 checked, 2 synced, 14 skipped\n  Conversations: 45 synced\n  Output: /tmp/claude-sync-test\n```\n\n## Implementation\nTrack counts during sync loop, print summary at end.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-07T14:54:37.373168+01:00","updated_at":"2025-12-07T17:13:41.189358+01:00","closed_at":"2025-12-07T17:13:41.189358+01:00"}
{"id":"claude-sync-acg","title":"Switch conversation sync to opt-out (default on)","description":"**Original task**: claude-sync-8co.11 (incorrectly implemented)\n\n**What was wrong**: Implemented as opt-in (-c/--conversations) but spec said default ON with --skip-conversations to disable.\n\n## Required Changes\n1. Remove -c/--conversations flag\n2. Add --skip-conversations flag\n3. Default: sync conversations\n4. With --skip-conversations: skip conversation sync\n\n## Config Change\n```python\n@dataclass\nclass Config:\n    skip_conversations: bool = False  # Default: sync conversations\n```\n\n## CLI Change\n```python\nparser.add_argument(\n    \"--skip-conversations\",\n    action=\"store_true\",\n    help=\"Skip syncing project conversations (faster)\",\n)\n```","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T14:59:12.874597+01:00","updated_at":"2025-12-07T15:10:19.118808+01:00","closed_at":"2025-12-07T15:10:19.118808+01:00"}
{"id":"claude-sync-aza","title":"Implement local status checking (no auth required)","description":"Implement the core local status functionality that works without authentication.\n\n## Overview\n\nRead local sync state files and provide useful status information without needing to call the claude.ai API.\n\n## Data Sources\n\n1. `index.json` - Main manifest with projects, sync time, doc counts\n2. `.sync-state.json` - Internal state with hashes, conversation metadata\n3. Per-project `conversations/index.json` - Conversation counts\n\n## Information to Display\n\n### Summary\n- Last sync timestamp and human-readable age (\"2 days ago\")\n- Output directory location\n- Total project count\n- Total document count (sum of docs_count)\n- Total conversation count (from sync state)\n- Orphaned project count\n\n### Recently Active Projects\n- Sort projects by `updated_at` from sync state\n- Show top 5-10 with name, doc count, last update date\n- Helps users see which projects have recent activity\n\n### Integrity Check\n- Verify all projects in index.json have corresponding directories\n- Check for orphaned directories not in manifest\n- Report any mismatches\n\n## Acceptance Criteria\n\n- [ ] `status` works without browser cookies / authentication\n- [ ] Shows last sync time with human-readable age\n- [ ] Shows project, doc, conversation counts\n- [ ] Shows recently active projects sorted by update time\n- [ ] Reports integrity issues if directories dont match manifest\n- [ ] Handles missing index.json gracefully (shows \"no sync data\")\n- [ ] Handles corrupted index.json gracefully\n\n## Implementation\n\n```python\ndef load_local_status(output_dir: Path) -\u003e dict:\n    \"\"\"Load and validate local sync state.\"\"\"\n    # Read index.json\n    # Read .sync-state.json\n    # Compute derived values\n    return {\n        \"synced_at\": ...,\n        \"age_seconds\": ...,\n        \"project_count\": ...,\n        \"doc_count\": ...,\n        \"conversation_count\": ...,\n        \"orphaned_count\": ...,\n        \"projects\": [...],  # sorted by updated_at\n        \"integrity\": {\"ok\": True, \"issues\": []}\n    }\n```\n\n## Files to Modify\n\n- `claude_sync.py`: Add `load_local_status()` function and wire into status command","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-09T09:49:52.605455+01:00","updated_at":"2025-12-09T10:18:02.061135+01:00","closed_at":"2025-12-09T10:18:02.061135+01:00","dependencies":[{"issue_id":"claude-sync-aza","depends_on_id":"claude-sync-3do","type":"blocks","created_at":"2025-12-09T09:51:57.384468+01:00","created_by":"jason"}]}
{"id":"claude-sync-b3p","title":"Add per-project progress feedback during sync","description":"Large syncs show no useful progress until completion. Users don't know if sync is stuck.\n\nCurrent behavior:\n- Progress bar shows 'project 1/42' but not which project\n- No indication of conversations/docs being synced\n- If stuck on project with 10k conversations, no feedback\n\nDesired behavior:\n- Show current project name in progress bar\n- Optionally show sub-progress (conversations synced, docs synced)\n- Print periodic status for very long syncs\n\nImplementation ideas:\n- Use tqdm.set_description() to show current project name\n- Consider nested progress bars for large projects\n- Print summary every N projects for visibility\n\nKeep it simple - don't over-engineer. Basic project name display would be a big improvement.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-09T09:43:07.153838+01:00","updated_at":"2025-12-09T09:43:07.153838+01:00"}
{"id":"claude-sync-bkw","title":"Incremental Sync","description":"Add incremental sync capability to only fetch changed projects/docs.\n\n## Goal\nReduce sync time from 30-60s to 2-5s for daily updates by only downloading what changed.\n\n## Efficiency Gains\n- Full sync: ~30 MB, 30-60s\n- Daily incremental: ~0.5 MB, 2-5s (97% reduction)\n\n## How It Works\n1. Store sync state (timestamps, doc hashes) in index.json\n2. On sync, fetch project list (lightweight)\n3. Compare updated_at timestamps with stored values\n4. Only download full content for changed projects\n\n## Key Limitation\nDocs don't have updated_at field - need content hashing:\n```python\nimport hashlib\ndef doc_hash(content: str) -\u003e str:\n    return hashlib.sha256(content.encode()).hexdigest()[:16]\n```\n\n## index.json Extension\n```json\n{\n  \"projects\": {\n    \"uuid-1\": {\n      \"remote_updated_at\": \"2025-01-15T10:30:00Z\",\n      \"local_synced_at\": \"2025-01-15T10:35:00Z\",\n      \"doc_hashes\": {\n        \"doc-uuid-1\": \"a1b2c3d4...\",\n        \"doc-uuid-2\": \"e5f6g7h8...\"\n      }\n    }\n  }\n}\n```\n\n## CLI\n- Default: incremental (if index.json exists)\n- --full: Force full sync (ignore cached state)\n\n## Dependencies\n- Requires MVP complete","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-07T13:15:58.592585+01:00","updated_at":"2025-12-07T14:47:18.561354+01:00","closed_at":"2025-12-07T14:47:18.561354+01:00","dependencies":[{"issue_id":"claude-sync-bkw","depends_on_id":"claude-sync-8co","type":"blocks","created_at":"2025-12-07T13:15:58.593873+01:00","created_by":"jason"}]}
{"id":"claude-sync-bkw.1","title":"Implement sync state storage","description":"Extend index.json to store sync state for incremental updates:\n\n## Fields to Track\n- remote_updated_at: Project's updated_at from API\n- local_synced_at: When we last synced this project\n- doc_hashes: SHA256 hashes of doc content (for change detection)\n\n## Implementation\n```python\ndef update_sync_state(index: dict, project_id: str, project_data: dict, docs: list):\n    index['projects'][project_id] = {\n        'name': project_data['name'],\n        'slug': slugify(project_data['name']),\n        'remote_updated_at': project_data['updated_at'],\n        'local_synced_at': datetime.now().isoformat(),\n        'doc_hashes': {\n            doc['uuid']: hashlib.sha256(doc['content'].encode()).hexdigest()[:16]\n            for doc in docs\n        }\n    }\n```\n\n## Backward Compatibility\n- If index.json exists but lacks sync state fields, treat as 'needs full sync'\n- Gracefully handle missing/malformed index.json","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T13:16:11.4343+01:00","updated_at":"2025-12-07T14:46:55.19922+01:00","closed_at":"2025-12-07T14:46:55.19922+01:00","dependencies":[{"issue_id":"claude-sync-bkw.1","depends_on_id":"claude-sync-bkw","type":"parent-child","created_at":"2025-12-07T13:16:11.43486+01:00","created_by":"jason"}]}
{"id":"claude-sync-bkw.2","title":"Implement change detection logic","description":"Implement logic to detect what changed since last sync:\n\n## Detection Algorithm\n```python\ndef get_changed_projects(index: dict, projects: list) -\u003e list:\n    changed = []\n    for project in projects:\n        pid = project['uuid']\n        stored = index.get('projects', {}).get(pid)\n        \n        if not stored:\n            # New project\n            changed.append((pid, 'new'))\n        elif project['updated_at'] \u003e stored['remote_updated_at']:\n            # Modified project\n            changed.append((pid, 'modified'))\n    \n    # Detect deleted projects\n    for stored_id in index.get('projects', {}).keys():\n        if not any(p['uuid'] == stored_id for p in projects):\n            changed.append((stored_id, 'deleted'))\n    \n    return changed\n```\n\n## Handling Deleted Projects\n- Option 1: Leave local files, mark as 'orphaned' in index\n- Option 2: Delete local files\n- Recommend Option 1 for safety (user can manually clean up)\n\n## Doc-Level Detection\nSince docs lack updated_at, compare hashes:\n```python\ndef docs_changed(stored_hashes: dict, new_docs: list) -\u003e bool:\n    new_hashes = {d['uuid']: doc_hash(d['content']) for d in new_docs}\n    return stored_hashes != new_hashes\n```","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T13:16:26.509828+01:00","updated_at":"2025-12-07T14:47:00.513221+01:00","closed_at":"2025-12-07T14:47:00.513221+01:00","dependencies":[{"issue_id":"claude-sync-bkw.2","depends_on_id":"claude-sync-bkw","type":"parent-child","created_at":"2025-12-07T13:16:26.510706+01:00","created_by":"jason"}]}
{"id":"claude-sync-bkw.3","title":"Add --full flag and test incremental sync","description":"Add CLI flag for full sync and test incremental behavior:\n\n## CLI Behavior\n- Default (with existing index.json): incremental sync\n- Default (no index.json): full sync\n- --full: Force full sync even if index.json exists\n\n## Test Plan\n1. Run initial sync (should be full)\n2. Wait, run again (should be incremental, fast)\n3. Modify a project in web UI\n4. Run sync, verify only that project updated\n5. Test --full flag forces complete resync\n\n## Metrics to Log\n- Projects checked: N\n- Projects changed: M\n- Time taken: Xs\n- Data transferred: X KB (estimate)\n\n## Expected Results\n- First sync: 30-60s, all projects\n- Incremental (no changes): 2-5s, project list only\n- Incremental (1 change): 5-10s, project list + 1 project","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T13:16:41.197278+01:00","updated_at":"2025-12-07T14:47:05.805943+01:00","closed_at":"2025-12-07T14:47:05.805943+01:00","dependencies":[{"issue_id":"claude-sync-bkw.3","depends_on_id":"claude-sync-bkw","type":"parent-child","created_at":"2025-12-07T13:16:41.197814+01:00","created_by":"jason"}]}
{"id":"claude-sync-bo1","title":"Rethink CLAUDE.md generation and /setup-sync integration patterns","description":"## Problem\n\nThe current design makes two assumptions that need questioning:\n\n1. **Auto-generating CLAUDE.md from prompt_template**: We automatically convert web project instructions into a CLAUDE.md file in each synced project folder. But is this the right transformation?\n\n2. **Global imports as default pattern**: `/setup-sync` suggests importing synced CLAUDE.md files into `~/.claude/CLAUDE.md`, which pollutes context across all sessions.\n\n## Questions to Answer\n\n### About the source data (prompt_template)\n\n1. **What are people actually putting in prompt_template?**\n   - Project-specific instructions that only make sense in that project context?\n   - General style guides / preferences that could apply broadly?\n   - Mix of both?\n   - How does this vary by user?\n\n2. **Is prompt_template semantically equivalent to CLAUDE.md?**\n   - Web project instructions are for conversations *within* that project\n   - CLAUDE.md is for Claude Code sessions *in a directory*\n   - Are these the same mental model? Or fundamentally different contexts?\n\n3. **What's the actual use case for having web project content locally?**\n   - Reference/search only (read the content, don't inject it)?\n   - Selective injection into specific local projects?\n   - Historical record / backup?\n   - Something else?\n\n### About the integration pattern\n\n4. **Should synced content be auto-injected at all?**\n   - Current: Generate CLAUDE.md, suggest @importing it\n   - Alternative: Just sync as docs, user manually references what they need\n   - Alternative: Different file naming that doesn't imply \"inject me\"\n\n5. **If injection is desired, what's the right scope?**\n   - Global (current suggestion) → context pollution\n   - Per-local-project → user manually sets up @imports where relevant\n   - On-demand → agent reads synced content when relevant, doesn't auto-inject\n\n6. **What about the other synced content (docs, conversations)?**\n   - These are currently just files, not auto-injected\n   - Is that the right model for prompt_template too?\n   - Should everything just be searchable/readable reference material?\n\n### About naming and conventions\n\n7. **Is CLAUDE.md the right filename for synced prompt_template?**\n   - CLAUDE.md has semantic meaning in Claude Code (auto-loaded)\n   - If we don't want auto-injection, different name avoids confusion\n   - Options: `prompt_template.md`, `project_instructions.md`, `web_instructions.md`\n\n8. **What signals should file/folder naming give?**\n   - Current: CLAUDE.md signals \"this is instructions for Claude\"\n   - Should synced content be clearly marked as \"reference only\"?\n\n## Possible Directions\n\n**Direction A: Reference-only model**\n- Rename CLAUDE.md to something else (e.g., `instructions.md` or `prompt_template.md`)\n- Synced content is for reading/searching, not auto-injection\n- `/setup-sync` becomes unnecessary or transforms into something else\n- User manually @imports specific files into specific projects if desired\n\n**Direction B: Selective injection model**\n- Keep CLAUDE.md but change `/setup-sync` to:\n  - Never suggest global imports\n  - Help user set up @imports in specific local project CLAUDE.md files\n  - Warn about context pollution\n\n**Direction C: Smart context model**\n- Don't generate CLAUDE.md at all from prompt_template\n- Synced content is purely reference material\n- Agent can read it when relevant (like any other docs)\n- New pattern: agent searches synced conversations/docs for context when needed\n\n## Scope of Changes\n\nOnce direction is chosen, update:\n\n### Code\n- `claude_sync.py`: File naming, what gets generated\n- Any CLAUDE.md generation logic\n\n### Commands\n- `.claude/commands/setup-sync.md`: Completely rethink or remove\n- `.claude/commands/claude-sync-onboard.md`: Update integration phase (depends on claude-sync-e3c)\n\n### Documentation\n- `README.md`: Output structure section, integration section\n- `CLAUDE.md`: Any references to the pattern\n- `docs/*.md`: Any relevant docs\n\n### Related\n- Check for comments in code that reference the old pattern\n- Update any examples that show the @import pattern\n\n## Process\n\n1. **Explore**: Gather real usage patterns if possible\n2. **Decide**: Pick a direction based on actual use cases\n3. **Implement**: Make code/naming changes\n4. **Document**: Update all human and agent-facing docs\n5. **Verify**: Ensure consistency across all touchpoints","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-09T10:04:42.45017+01:00","updated_at":"2025-12-09T10:05:16.788866+01:00","dependencies":[{"issue_id":"claude-sync-bo1","depends_on_id":"claude-sync-8dh","type":"blocks","created_at":"2025-12-09T10:05:46.30681+01:00","created_by":"jason"},{"issue_id":"claude-sync-bo1","depends_on_id":"claude-sync-2u0","type":"blocks","created_at":"2025-12-09T10:05:51.451347+01:00","created_by":"jason"}]}
{"id":"claude-sync-c5f","title":"Add signal handling for graceful Ctrl+C interruption","description":"## Problem\nPressing Ctrl+C during sync leaves the filesystem in an inconsistent state:\n- Half-written project directories\n- `.sync-state.json` NOT saved (line 1248 not reached)\n- `index.json` NOT saved (line 1247 not reached)\n- Git commit NOT made (line 1252 not reached)\n\n## Current Behavior\n1. User presses Ctrl+C\n2. Python raises `KeyboardInterrupt`\n3. NOT caught by any exception handler (only catches `Exception`, not `BaseException`)\n4. Process terminates immediately\n5. User must manually inspect/clean up filesystem\n\n## Implementation\n\n### Option A: Catch KeyboardInterrupt at top level\n```python\ndef main():\n    try:\n        return sync(config)\n    except KeyboardInterrupt:\n        log.warning(\"\\nSync interrupted by user\")\n        log.info(\"Partial sync state NOT saved - next sync will retry\")\n        return 130  # Standard exit code for SIGINT\n```\n\n### Option B: Signal handler with cleanup\n```python\nimport signal\n\n_interrupted = False\n\ndef handle_sigint(signum, frame):\n    global _interrupted\n    if _interrupted:\n        # Second Ctrl+C - force exit\n        log.warning(\"Force exit\")\n        sys.exit(130)\n    _interrupted = True\n    log.warning(\"\\nInterrupt received, finishing current project...\")\n\ndef sync(config):\n    signal.signal(signal.SIGINT, handle_sigint)\n    \n    for project in projects:\n        if _interrupted:\n            log.info(\"Stopping after current project\")\n            break\n        sync_project(project)\n    \n    # Save state even if interrupted\n    save_sync_state(...)\n```\n\n### Option C: Context manager for cleanup\n```python\n@contextmanager\ndef graceful_sync():\n    interrupted = False\n    original_handler = signal.getsignal(signal.SIGINT)\n    \n    def handler(sig, frame):\n        nonlocal interrupted\n        interrupted = True\n        log.warning(\"Interrupt received, will stop after current project\")\n    \n    signal.signal(signal.SIGINT, handler)\n    try:\n        yield lambda: interrupted\n    finally:\n        signal.signal(signal.SIGINT, original_handler)\n```\n\n## Recommended Approach\nOption B - allows graceful stop after current project:\n1. First Ctrl+C: Set flag, finish current project, save state, exit\n2. Second Ctrl+C: Force immediate exit\n\n## Gotchas\n- SIGTERM should also be handled (for kill command, systemd, etc.)\n- Windows uses different signal handling - test on Windows\n- Don't leave half-written files - either complete current file or don't start it\n- tqdm progress bar may need cleanup on interrupt\n\n## Additional Signals to Handle\n- SIGTERM: Graceful shutdown (same as first Ctrl+C)\n- SIGHUP: Could trigger re-read of config (optional)\n\n## Test Plan\n1. Start sync with multiple projects\n2. Press Ctrl+C during project 3 of 10\n3. Verify:\n   - \"Interrupt received\" message shown\n   - Project 3 completes (or is cleanly skipped)\n   - .sync-state.json is saved with projects 1-3 (or 1-2)\n   - Exit code is 130\n4. Run sync again\n5. Verify: Only projects 4-10 need syncing (incremental works)\n\n### Force exit test\n1. Start sync\n2. Press Ctrl+C twice quickly\n3. Verify immediate exit\n\n## Before Closing\n- [ ] Add signal handler for SIGINT\n- [ ] Add signal handler for SIGTERM\n- [ ] Test single Ctrl+C (graceful)\n- [ ] Test double Ctrl+C (force)\n- [ ] Verify state saved on interrupt\n- [ ] git commit","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-07T15:14:18.159572+01:00","updated_at":"2025-12-07T15:31:41.310432+01:00","closed_at":"2025-12-07T15:31:41.310432+01:00"}
{"id":"claude-sync-c67","title":"Improve API error handling: non-JSON responses, 5xx retry","description":"## Problem\nThe API client has several error handling gaps that cause crashes or poor error messages.\n\n## Issues Found\n\n### 1. Non-JSON responses crash with unhelpful error\n**Location**: Line 285 - `response.json()`\n\n**Scenario**: Cloudflare returns HTML error page instead of JSON\n```html\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\u003cbody\u003eAccess Denied\u003c/body\u003e\u003c/html\u003e\n```\n\n**Current behavior**: `json.JSONDecodeError` with confusing message\n**Should**: Detect HTML, provide helpful error like \"API returned HTML - possible Cloudflare block\"\n\n### 2. 5xx server errors not retried\n**Location**: Lines 274-277\n\n```python\nif response.status_code \u003e= 500:\n    raise APIError(\n        f\"Claude.ai server error ({response.status_code}).\\n\"\n        \"Try again later.\"\n    )\n```\n\n**Current behavior**: Immediate failure on 500/502/503\n**Should**: Retry with backoff (server errors are often transient)\n\n### 3. Empty response body crashes\n**Location**: Line 285\n\n**Scenario**: Server returns 200 with empty body\n**Current behavior**: `json.JSONDecodeError` \n**Should**: Specific error \"Empty response from API\"\n\n### 4. Content-Type not validated\n**Location**: Line 252\n\n**Should check**: `response.headers.get('content-type', '').startswith('application/json')`\n\n## Implementation\n\n### Fix 1: Validate response before parsing JSON\n```python\ndef _api_request(...):\n    # ... existing code ...\n    \n    response.raise_for_status()\n    \n    # Validate response before parsing\n    content_type = response.headers.get('content-type', '')\n    if not content_type.startswith('application/json'):\n        body_preview = response.text[:200]\n        if '\u003chtml' in body_preview.lower():\n            raise APIError(\n                \"API returned HTML instead of JSON.\\n\"\n                \"This usually means Cloudflare blocked the request.\\n\"\n                \"Try again in a few minutes, or check if claude.ai is accessible in browser.\"\n            )\n        raise APIError(f\"Unexpected content-type: {content_type}\")\n    \n    if not response.text.strip():\n        raise APIError(\"Empty response from API\")\n    \n    try:\n        return response.json()\n    except json.JSONDecodeError as e:\n        raise APIError(f\"Invalid JSON response: {e}\") from e\n```\n\n### Fix 2: Retry 5xx errors\n```python\n# In _api_request retry loop:\nif response.status_code \u003e= 500:\n    if attempt \u003c retries - 1:\n        wait_time = 2 ** attempt  # Exponential backoff: 1s, 2s, 4s\n        log.warning(f\"Server error {response.status_code}, retrying in {wait_time}s...\")\n        time.sleep(wait_time)\n        continue\n    raise APIError(\n        f\"Claude.ai server error ({response.status_code}) after {retries} attempts.\\n\"\n        \"Try again later.\"\n    )\n```\n\n### Fix 3: Better error categorization\n```python\n# Categorize errors for better messages\nif response.status_code == 502:\n    error_hint = \"Bad Gateway - Claude.ai may be deploying updates\"\nelif response.status_code == 503:\n    error_hint = \"Service Unavailable - Claude.ai may be overloaded\"\nelif response.status_code == 504:\n    error_hint = \"Gateway Timeout - request took too long\"\nelse:\n    error_hint = \"Server error\"\n```\n\n## Gotchas\n- Don't retry 4xx errors (client errors, won't help)\n- Retry limit for 5xx should be same as network errors (3)\n- Exponential backoff to avoid hammering server\n- Log each retry attempt for debugging\n- Consider: different retry logic for different endpoints?\n\n## Test Plan\n\n### Non-JSON response\n1. Mock API to return HTML\n2. Verify error message mentions \"HTML\" and \"Cloudflare\"\n3. Verify no stack trace with JSONDecodeError\n\n### 5xx retry\n1. Mock API to return 503 twice, then 200\n2. Verify retries happen with backoff\n3. Verify succeeds on third attempt\n4. Verify log shows retry attempts\n\n### Empty response\n1. Mock API to return 200 with empty body\n2. Verify error message says \"Empty response\"\n\n## Before Closing\n- [ ] Add content-type validation\n- [ ] Add empty body check\n- [ ] Add 5xx retry with exponential backoff\n- [ ] Add better error messages for each 5xx code\n- [ ] Test all error scenarios\n- [ ] git commit","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-07T15:15:16.271542+01:00","updated_at":"2025-12-07T15:26:38.763171+01:00","closed_at":"2025-12-07T15:26:38.763171+01:00"}
{"id":"claude-sync-cez","title":"Create incremental sync test plan for user verification","description":"**Original task**: claude-sync-bkw.3 (partially implemented)\n\n**What was missing**: Test plan for user to verify incremental sync with actual remote changes.\n\n## Test Plan Document\nCreate a test plan the user can follow to verify incremental sync with real changes:\n\n### Test 1: Project Metadata Change\n1. Run full sync\n2. In claude.ai web UI, edit project description\n3. Run sync again\n4. Verify: Only that project re-synced, others skipped\n\n### Test 2: Document Change\n1. Run full sync\n2. In claude.ai web UI, edit a document in a project\n3. Run sync again\n4. Verify: Only that project re-synced\n\n### Test 3: New Document\n1. Run full sync\n2. In claude.ai web UI, add new document to a project\n3. Run sync again\n4. Verify: Only that project re-synced, new doc appears\n\n### Test 4: Conversation Change\n1. Run full sync (with conversations)\n2. In claude.ai web UI, send a message in a project conversation\n3. Run sync again\n4. Verify: Only that conversation re-synced\n\n### Test 5: New Conversation\n1. Run full sync (with conversations)\n2. In claude.ai web UI, start new conversation in a project\n3. Run sync again\n4. Verify: New conversation synced, others skipped\n\n## Output\n- Add test plan to docs/TESTING.md\n- Include expected output for each test","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T15:00:05.27685+01:00","updated_at":"2025-12-07T15:11:14.412857+01:00","closed_at":"2025-12-07T15:11:14.412857+01:00"}
{"id":"claude-sync-cs3","title":"Security: Session key exposure risk in verbose tracebacks","description":"## Problem\nWhen running with `--verbose` flag, uncaught exceptions print full tracebacks that could expose the sessionKey cookie value.\n\n## Location\nLines 1274-1279:\n```python\nexcept Exception as e:\n    log.error(f\"Sync failed: {e}\")\n    if config.verbose:\n        import traceback\n        traceback.print_exc()\n    return 1\n```\n\n## Attack Scenario\n1. User runs `./claude_sync.py -v` (verbose mode)\n2. Exception occurs during API request where session object is in scope\n3. If curl_cffi's Session repr includes cookies, sessionKey appears in traceback\n4. Traceback written to terminal (captured in logs, screen recordings, etc.)\n5. Session key exposed → account compromise risk\n\n## Evidence\nThe session object at line 218 contains cookies:\n```python\nsession.cookies.update(cookies)  # cookies dict includes sessionKey\n```\n\nIf an exception references this session object, Python's traceback may print its repr.\n\n## Additional Credential Exposure Points\n\n### Error messages that might contain credentials (HIGH)\n- Line 131: `f\"Original error: {e}\"` - browser_cookie3 exceptions might include cookie values\n- Line 142: `f\"Failed to extract cookies from {browser}: {e}\"`\n\n### Debug logging (MEDIUM)\n- Line 147: `log.debug(f\"Found cookies: {cookie_names}\")` - only names, not values (OK)\n- Line 251: `log.debug(f\"GET {url}\")` - URLs contain org UUIDs (info disclosure)\n\n## Implementation Hints\n\n### Option A: Sanitize tracebacks\n```python\ndef sanitize_traceback(tb_string: str) -\u003e str:\n    \"\"\"Remove potential credential data from traceback.\"\"\"\n    import re\n    # Redact long alphanumeric strings (session keys, tokens)\n    sanitized = re.sub(r'sessionKey[\"\\']?\\s*[:=]\\s*[\"\\']?[a-zA-Z0-9_-]{20,}', \n                       'sessionKey=[REDACTED]', tb_string)\n    # Redact any long hex/base64 strings\n    sanitized = re.sub(r'\\b[a-zA-Z0-9_-]{40,}\\b', '[REDACTED]', sanitized)\n    return sanitized\n\n# Usage:\nif config.verbose:\n    import traceback\n    tb = traceback.format_exc()\n    log.error(sanitize_traceback(tb))\n```\n\n### Option B: Use custom exception handler\n```python\ndef safe_print_exception():\n    \"\"\"Print exception without sensitive data.\"\"\"\n    import sys\n    exc_type, exc_value, exc_tb = sys.exc_info()\n    # Print type and message only, not full traceback with locals\n    log.error(f\"{exc_type.__name__}: {exc_value}\")\n```\n\n### Option C: Sanitize error messages at source\nAdd helper function used by all error logging:\n```python\ndef sanitize_error(msg: str) -\u003e str:\n    \"\"\"Remove potential secrets from error message.\"\"\"\n    return re.sub(r'[a-zA-Z0-9_-]{30,}', '[REDACTED]', str(msg))\n```\n\n## Gotchas\n- Don't over-redact: UUIDs are 36 chars, session keys are longer\n- Test that useful error info is preserved\n- Consider: should we log sanitized version AND write full version to secure file?\n\n## Test Plan\n1. Force an exception during API request (e.g., mock network error)\n2. Run with -v flag\n3. Capture output\n4. Verify no strings \u003e30 chars that look like tokens appear\n5. Verify useful error info (exception type, message) still appears\n\n## Before Closing\n- [ ] Implement traceback sanitization\n- [ ] Implement error message sanitization\n- [ ] Test with forced exceptions\n- [ ] Verify useful info preserved\n- [ ] git commit with security note","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-07T15:13:26.567502+01:00","updated_at":"2025-12-07T15:26:49.308428+01:00","closed_at":"2025-12-07T15:26:49.308428+01:00"}
{"id":"claude-sync-cyb","title":"Unify duplicate .md extension logic","description":"Same .md extension enforcement pattern repeated 3+ times:\n\nLocations:\n- Lines 1019-1020 (doc processing)\n- Lines 1033-1034 (doc rename detection)  \n- Lines 1055-1056 (deleted doc cleanup)\n- Lines 1456-1458 and 1515-1516 (conversation writes)\n\nPattern:\nif not filename.lower().endswith('.md'):\n    filename = f'{filename}.md'\n\nFix:\nExtract to helper function:\ndef ensure_md_extension(filename: str) -\u003e str:\n    if not filename.lower().endswith('.md'):\n        return f'{filename}.md'\n    return filename\n\nBenefits:\n- Single place to fix bugs\n- Consistent behavior\n- Easier to test","status":"open","priority":3,"issue_type":"chore","created_at":"2025-12-09T09:43:49.85481+01:00","updated_at":"2025-12-09T09:43:49.85481+01:00"}
{"id":"claude-sync-daw","title":"Orphan files/folders not cleaned up on deletion or rename","description":"","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-07T15:45:54.162605+01:00","updated_at":"2025-12-07T16:58:33.18464+01:00","closed_at":"2025-12-07T16:58:33.18464+01:00","dependencies":[{"issue_id":"claude-sync-daw","depends_on_id":"claude-sync-ivi","type":"blocks","created_at":"2025-12-07T15:46:23.831147+01:00","created_by":"jason"}]}
{"id":"claude-sync-dcz","title":"Bug: Message content extraction from API content array","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-07T15:26:36.517847+01:00","updated_at":"2025-12-07T15:26:47.142732+01:00","closed_at":"2025-12-07T15:26:47.142732+01:00"}
{"id":"claude-sync-dex","title":"Add file locking to prevent concurrent sync corruption","description":"## Problem\nTwo simultaneous sync processes will corrupt each other's output:\n- Both read same `.sync-state.json`\n- Both write to same directories\n- Both write to same `index.json` and `.sync-state.json`\n- Last write wins, unpredictable results\n\n## Scenario\n1. User runs `claude-sync` in terminal\n2. Cron job also triggers `claude-sync`\n3. Both processes:\n   - Read same state (both think all projects need sync)\n   - Write to same directories (interleaved writes)\n   - Write state files (last one wins, loses other's progress)\n4. Result: Corrupted state, missing syncs, possible file corruption\n\n## Implementation Options\n\n### Option A: PID file (simple, recommended)\n```python\nimport fcntl\nimport os\n\nLOCK_FILE = \".claude-sync.lock\"\n\ndef acquire_lock(output_dir: Path) -\u003e int:\n    \"\"\"Acquire exclusive lock. Returns file descriptor or raises.\"\"\"\n    lock_path = output_dir / LOCK_FILE\n    fd = os.open(lock_path, os.O_CREAT | os.O_RDWR)\n    try:\n        fcntl.flock(fd, fcntl.LOCK_EX | fcntl.LOCK_NB)\n    except BlockingIOError:\n        os.close(fd)\n        # Read PID from lock file\n        with open(lock_path) as f:\n            pid = f.read().strip()\n        raise RuntimeError(f\"Another sync is running (PID: {pid})\")\n    \n    # Write our PID\n    os.ftruncate(fd, 0)\n    os.write(fd, str(os.getpid()).encode())\n    return fd\n\ndef release_lock(fd: int):\n    \"\"\"Release lock and close file descriptor.\"\"\"\n    fcntl.flock(fd, fcntl.LOCK_UN)\n    os.close(fd)\n```\n\n### Option B: Lock directory (more portable)\n```python\ndef acquire_lock(output_dir: Path) -\u003e Path:\n    lock_dir = output_dir / \".sync.lock\"\n    try:\n        lock_dir.mkdir(exist_ok=False)  # Atomic on most filesystems\n    except FileExistsError:\n        raise RuntimeError(f\"Another sync is running (lock: {lock_dir})\")\n    \n    # Write PID for debugging\n    (lock_dir / \"pid\").write_text(str(os.getpid()))\n    return lock_dir\n\ndef release_lock(lock_dir: Path):\n    shutil.rmtree(lock_dir)\n```\n\n### Option C: fcntl on state file\nLock the .sync-state.json file itself:\n```python\nwith open(state_path, 'r+') as f:\n    fcntl.flock(f, fcntl.LOCK_EX | fcntl.LOCK_NB)\n    # ... do sync ...\n    fcntl.flock(f, fcntl.LOCK_UN)\n```\n\n## Recommended Approach\nOption A (PID file with flock):\n- Works on all Unix systems\n- Shows which process holds lock\n- Automatically released if process crashes\n- fcntl.LOCK_NB means non-blocking (fail immediately if locked)\n\n## Usage in sync()\n```python\ndef sync(config: Config) -\u003e int:\n    # Acquire lock first\n    try:\n        lock_fd = acquire_lock(config.output_dir)\n    except RuntimeError as e:\n        log.error(str(e))\n        return 1\n    \n    try:\n        # ... existing sync logic ...\n        return 0\n    finally:\n        release_lock(lock_fd)\n```\n\n## Gotchas\n- **Windows compatibility**: fcntl doesn't exist on Windows, need msvcrt.locking()\n- **Stale locks**: If process crashes, lock file remains but flock is released\n- **NFS filesystems**: flock may not work correctly on NFS\n- **Docker/containers**: Lock files may not be shared between containers\n\n## Cross-platform Solution\n```python\nimport sys\n\nif sys.platform == 'win32':\n    import msvcrt\n    def lock_file(fd):\n        msvcrt.locking(fd, msvcrt.LK_NBLCK, 1)\n    def unlock_file(fd):\n        msvcrt.locking(fd, msvcrt.LK_UNLCK, 1)\nelse:\n    import fcntl\n    def lock_file(fd):\n        fcntl.flock(fd, fcntl.LOCK_EX | fcntl.LOCK_NB)\n    def unlock_file(fd):\n        fcntl.flock(fd, fcntl.LOCK_UN)\n```\n\n## Test Plan\n1. Start sync (will take time with many projects)\n2. In another terminal, start sync again\n3. Verify second sync fails immediately with \"Another sync is running\"\n4. Wait for first sync to complete\n5. Run second sync again\n6. Verify it succeeds\n\n### Crash recovery test\n1. Start sync\n2. Kill process with SIGKILL (kill -9)\n3. Run sync again\n4. Verify it succeeds (flock auto-released)\n\n## Before Closing\n- [ ] Implement file locking (Unix)\n- [ ] Consider Windows compatibility\n- [ ] Test concurrent sync rejection\n- [ ] Test crash recovery\n- [ ] Add --force-unlock flag for stuck locks (optional)\n- [ ] git commit","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-07T15:14:47.958834+01:00","updated_at":"2025-12-07T15:36:59.836239+01:00","closed_at":"2025-12-07T15:36:59.836239+01:00"}
{"id":"claude-sync-e17","title":"Replace bare except clauses with except Exception","description":"Lines 110, 125, 817 use bare 'except:' which catches KeyboardInterrupt and SystemExit. Should use 'except Exception:' for better exception hygiene. Low impact since these are in error handling paths, but good practice to fix.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-07T17:14:00.665257+01:00","updated_at":"2025-12-07T17:25:50.988819+01:00","closed_at":"2025-12-07T17:25:50.988819+01:00"}
{"id":"claude-sync-e3c","title":"Add /claude-sync-onboard slash command for guided first-time setup","description":"## Goal\n\nCreate a project-local slash command that guides users through complete claude-sync setup, from first run to optional daily automation. This is a one-time onboarding experience for new users who clone this repository.\n\n## Why a Slash Command?\n\n- **Discoverable**: Users see `/claude-sync-onboard` in command list when working in this repo\n- **Self-documenting**: The command file describes what it does\n- **Agent-friendly**: Gives Claude Code clear instructions for a complex multi-step process\n- **One-time use**: Most users run once, then use automated sync thereafter\n\n## Command Name\n\n`/claude-sync-onboard` - specific enough to avoid clashes, clear about purpose.\n\nAlternatives considered:\n- `/setup-daily-sync` - too narrow (also covers first run)\n- `/onboard` - too generic, likely to clash\n- `/claude-sync-setup` - could clash with existing `/setup-sync` in user's mind\n\n## Location\n\n`.claude/commands/claude-sync-onboard.md` in this repository (project-specific)\n\n## Workflow\n\nThe command should guide the agent through these steps, adapting to user's situation:\n\n### Phase 1: Environment Check\n\n1. **Detect platform**: macOS vs Linux (affects automation method)\n2. **Check prerequisites**: \n   - Python 3.12+ installed?\n   - UV installed?\n   - Browser available (Edge/Chrome)?\n3. **Check existing state**:\n   - Is there already synced data in `~/.local/share/claude-sync/`?\n   - Is automation already set up? (check launchd/cron)\n\n### Phase 2: Org Discovery \u0026 First Sync\n\n4. **Discover organizations**: Run `./claude_sync.py --list-orgs`\n5. **Help user choose org** if multiple found\n6. **Run initial sync**: Execute first sync with chosen org\n7. **Verify success**: Check output directory populated\n\n### Phase 3: Integration (leverage existing /setup-sync)\n\n8. **Suggest running /setup-sync** for CLAUDE.md integration\n   - Or inline that logic if cleaner\n\n### Phase 4: Optional Automation Setup\n\n9. **Ask if user wants daily automation**\n10. **If yes, set up platform-appropriate automation**:\n    - **macOS**: Create wrapper script + launchd plist, load it\n    - **Linux**: Create wrapper script + cron entry\n11. **Test automation** runs correctly\n12. **Verify scheduled** properly\n\n### Phase 5: Summary\n\n13. **Summarize what was set up**:\n    - Org synced\n    - Output location\n    - Automation schedule (if enabled)\n    - How to check logs\n    - How to run manual sync\n\n## Key Principles\n\n- **Ask, don't assume**: Use AskUserQuestion for choices (org selection, automation yes/no, schedule)\n- **Platform-aware**: Detect macOS vs Linux, use appropriate scheduler\n- **Idempotent-ish**: Handle re-running gracefully (detect existing setup)\n- **Hands-off automation**: Agent does the work, user approves key decisions\n- **Clear explanations**: Tell user what's happening and why at each step\n\n## Agent Guidance (in the command file)\n\nThe command should tell the agent:\n- This is a guided onboarding, not a quick task\n- Use AskUserQuestion for user choices\n- Adapt to what's already set up (don't redo completed steps)\n- Be explicit about what will be created/modified before doing it\n- Verify each phase succeeded before moving to next\n- Handle errors gracefully with clear recovery guidance\n\n## Relationship to Other Issues\n\n- **Depends on claude-sync-fye** (automation implementation): The automation setup phase needs that implementation to exist\n- **Complements /setup-sync**: That command handles CLAUDE.md integration; this command handles everything else and can invoke/suggest it\n\n## Files Created\n\n- `.claude/commands/claude-sync-onboard.md` - The slash command definition\n\n## Testing\n\n- Fresh clone: Full onboarding flow works\n- Existing sync, no automation: Skips to automation setup\n- Everything set up: Reports status, offers to re-run sync","status":"open","priority":3,"issue_type":"feature","created_at":"2025-12-09T09:54:14.715453+01:00","updated_at":"2025-12-09T09:54:48.411079+01:00","dependencies":[{"issue_id":"claude-sync-e3c","depends_on_id":"claude-sync-fye","type":"blocks","created_at":"2025-12-09T09:54:59.405378+01:00","created_by":"jason"},{"issue_id":"claude-sync-e3c","depends_on_id":"claude-sync-bo1","type":"blocks","created_at":"2025-12-09T10:06:01.90879+01:00","created_by":"jason"}]}
{"id":"claude-sync-fri","title":"Refactor monolithic sync() function into testable units","description":"The sync() function is 417 lines and handles 5+ concerns:\n- Session setup\n- Project iteration  \n- Conversation iteration\n- Standalone conversation iteration\n- State management\n- Error handling\n\nThis makes it:\n- Hard to test individual components\n- Difficult to maintain\n- Easy to introduce bugs\n\nRefactor into smaller functions:\n- sync_project() - handle single project sync\n- sync_conversations() - handle conversation sync for a project\n- sync_standalone_conversations() - handle standalone convos\n- Keep sync() as orchestrator\n\nBenefits:\n- Each function can be tested independently\n- Clearer separation of concerns\n- Easier to add features\n\nNote: This should be done BEFORE adding tests (makes testing much easier).","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-09T09:41:46.746748+01:00","updated_at":"2025-12-09T09:41:46.746748+01:00"}
{"id":"claude-sync-fye","title":"Add launchd automation for scheduled sync","description":"## Goal\n\nSet up launchd-based automation to run claude-sync daily, keeping local copies of claude.ai projects current without manual intervention.\n\n## Why This Matters\n\n- Projects and docs update on claude.ai without local awareness\n- Manual syncing is easy to forget\n- Incremental sync is already implemented (efficient re-runs)\n- Follows same pattern as existing automations (sync-dotfiles, sync-claude-config)\n\n## Implementation\n\n### 1. Wrapper Script (run-claude-sync.sh)\n\nCreate in repo root (project-specific automation):\n\n```bash\n#!/bin/bash\n# AUTOMATION: claude-sync\n# PURPOSE: Sync claude.ai web projects to local storage\n# SCHEDULE: Daily at 6:00 AM (or on wake if missed)\n# EXPECTED RUNTIME: 1-5 minutes depending on changes\n\nset -euo pipefail\n\nlog() { echo \"[$(date '+%Y-%m-%d %H:%M:%S')] $*\"; }\nlog_error() { echo \"[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $*\" \u003e\u00262; }\n\nlog \"==========================================\"\nlog \"Starting automation: claude-sync\"\nlog \"==========================================\"\n\nexport PATH=\"/Users/jason/.cargo/bin:/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin\"\n\nSCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" \u0026\u0026 pwd)\"\ncd \"$SCRIPT_DIR\" || exit 1\n\nlog \"Working directory: $(pwd)\"\nlog \"UV: $(which uv)\"\n\nlog \"Executing: uv run claude_sync.py\"\n\nif uv run claude_sync.py; then\n    log \"Sync completed successfully\"\nelse\n    EXIT_CODE=$?\n    log_error \"Sync failed (exit code: $EXIT_CODE)\"\n    exit $EXIT_CODE\nfi\n\nlog \"==========================================\"\nlog \"Finished automation: claude-sync\"\nlog \"==========================================\"\n```\n\n### 2. Launchd Plist (com.user.claude-sync.plist)\n\n```xml\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e\n\u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e\n\u003cplist version=\"1.0\"\u003e\n\u003cdict\u003e\n    \u003ckey\u003eLabel\u003c/key\u003e\n    \u003cstring\u003ecom.user.claude-sync\u003c/string\u003e\n    \u003ckey\u003eProgramArguments\u003c/key\u003e\n    \u003carray\u003e\n        \u003cstring\u003e/Users/jason/Code/claude-sync/run-claude-sync.sh\u003c/string\u003e\n    \u003c/array\u003e\n    \u003ckey\u003eStartCalendarInterval\u003c/key\u003e\n    \u003cdict\u003e\n        \u003ckey\u003eHour\u003c/key\u003e\n        \u003cinteger\u003e6\u003c/integer\u003e\n        \u003ckey\u003eMinute\u003c/key\u003e\n        \u003cinteger\u003e0\u003c/integer\u003e\n    \u003c/dict\u003e\n    \u003ckey\u003eStandardOutPath\u003c/key\u003e\n    \u003cstring\u003e/tmp/claude-sync.log\u003c/string\u003e\n    \u003ckey\u003eStandardErrorPath\u003c/key\u003e\n    \u003cstring\u003e/tmp/claude-sync.log\u003c/string\u003e\n    \u003ckey\u003eRunAtLoad\u003c/key\u003e\n    \u003cfalse/\u003e\n\u003c/dict\u003e\n\u003c/plist\u003e\n```\n\n### 3. Installation Steps\n\n```bash\nchmod +x run-claude-sync.sh\n./run-claude-sync.sh  # Test manually\ncp com.user.claude-sync.plist ~/Library/LaunchAgents/\nlaunchctl load ~/Library/LaunchAgents/com.user.claude-sync.plist\nlaunchctl list | grep claude-sync\n```\n\n## Prerequisites\n\n- Browser session must have active claude.ai login (uses browser cookies)\n- UV must be installed and in PATH\n\n## Notes\n\n- Logs to /tmp/claude-sync.log\n- Runs at 6 AM daily; launchd handles wake-from-sleep (runs missed jobs)\n- Uses incremental sync - only fetches changed content","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-09T09:51:20.96543+01:00","updated_at":"2025-12-09T09:51:41.143356+01:00","dependencies":[{"issue_id":"claude-sync-fye","depends_on_id":"claude-sync-w6i","type":"blocks","created_at":"2025-12-09T09:51:50.620221+01:00","created_by":"jason"}]}
{"id":"claude-sync-g6g","title":"Add --check-docs flag for thorough doc change detection","description":"Add optional --check-docs flag to status --remote for thorough document change detection.\n\n## Background\n\nDocuments in the claude.ai API have no `updated_at` field. The only way to detect doc changes is to:\n1. Fetch all document content\n2. Hash each document\n3. Compare hashes with cached values in .sync-state.json\n\nThis is expensive (many API calls, lots of data transfer) so it should be opt-in.\n\n## Behavior\n\nWhen `status --remote --check-docs` is invoked:\n1. For each project with potential changes (updated_at differs)\n2. Fetch all docs via `GET /projects/{id}/docs?tree=true`\n3. Hash each doc content\n4. Compare with cached hashes in .sync-state.json\n5. Report which specific docs changed\n\n## Output\n\n```\n[MOD]  \"Apart Lab General\"\n       - Instructions: unchanged\n       - Docs: 2 of 23 changed\n         - style-guide.md (modified)\n         - requirements.md (new)\n       - Conversations: +3 new\n```\n\n## Acceptance Criteria\n\n- [ ] `--check-docs` flag only works with `--remote`\n- [ ] Shows which specific documents changed\n- [ ] Distinguishes new vs modified vs deleted docs\n- [ ] Shows progress during doc fetching (can be slow)\n- [ ] Works correctly when .sync-state.json has no doc hashes (fresh sync)\n\n## Implementation Notes\n\n- Reuse existing `compute_doc_hash()` function\n- Consider batching/parallelizing doc fetches for performance\n- Warn user this may be slow for large projects\n\n## Files to Modify\n\n- `claude_sync.py`: Extend `fetch_remote_status()` to optionally fetch and hash docs","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-09T09:50:29.153373+01:00","updated_at":"2025-12-09T09:50:29.153373+01:00","dependencies":[{"issue_id":"claude-sync-g6g","depends_on_id":"claude-sync-w62","type":"blocks","created_at":"2025-12-09T09:52:12.771805+01:00","created_by":"jason"}]}
{"id":"claude-sync-hbx","title":"Add user-visible logging for file moves/renames/deletions","description":"","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-07T16:51:56.970376+01:00","updated_at":"2025-12-07T16:58:38.445614+01:00","closed_at":"2025-12-07T16:58:38.445614+01:00"}
{"id":"claude-sync-ibu","title":"Add conversations/index.json manifest","description":"**Original task**: claude-sync-8co.11 (partially implemented)\n\n**What was missing**: No conversations/index.json manifest file.\n\n## Required Implementation\nCreate conversations/index.json with conversation metadata:\n\n```json\n{\n  \"synced_at\": \"2025-12-07T...\",\n  \"conversations\": {\n    \"\u003cuuid\u003e\": {\n      \"name\": \"Conversation Title\",\n      \"filename\": \"conversation-title.md\",\n      \"created_at\": \"...\",\n      \"updated_at\": \"...\",\n      \"message_count\": 15\n    }\n  }\n}\n```\n\n## Benefits\n- Quick lookup of conversation metadata\n- Support incremental sync (store updated_at)\n- Avoid parsing markdown files to get metadata","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T14:59:30.568153+01:00","updated_at":"2025-12-07T15:10:24.374421+01:00","closed_at":"2025-12-07T15:10:24.374421+01:00"}
{"id":"claude-sync-ivi","title":"Handle remote renames gracefully","description":"## Problem\nRenaming a project/doc/conversation remotely creates duplicate local files:\n- Old file with old name persists\n- New file with new name is created\n\n## Root Cause\nWe derive local filenames from remote names each sync, but don't track the mapping.\n\n## Current Behavior\n1. Sync project \"Foo\" → creates foo-abc123/\n2. Rename to \"Bar\" remotely\n3. Sync again → creates bar-abc123/, foo-abc123/ persists\n\n## Solution Options\n1. **Track mapping**: Store {uuid: local_path} in sync state, detect renames, delete old files\n2. **UUID-based paths**: Use UUID as primary path, name as symlink/metadata only\n3. **Document limitation**: Tell users to use --full and delete output dir for renames\n\nRecommend option 1 for docs/conversations, option 2 for projects (UUIDs in folder names already partially solve this - slug includes UUID).\n\n## Workaround\nFor now: Run with --full and delete output directory before sync to clean up renames.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-07T15:04:52.747073+01:00","updated_at":"2025-12-07T17:13:35.918613+01:00","closed_at":"2025-12-07T17:13:35.918613+01:00"}
{"id":"claude-sync-j26","title":"Replace broad except Exception catches with specific handling","description":"8+ locations use broad 'except Exception' that can mask bugs and make debugging harder.\n\nLocations identified:\n- Line 118: lock acquisition\n- Line 134: lock release (pass silently)\n- Line 291, 492, 871, 1897, 2004, 2055: various error handling\n\nProblems:\n- Masks NameError, TypeError, AttributeError bugs\n- Makes debugging difficult\n- Swallows useful error context\n\nFix approach:\n- Replace with specific exception types where possible (OSError, json.JSONDecodeError, etc.)\n- Where broad catch is needed, ensure full traceback is logged\n- At minimum: log the full exception before continuing\n\nBest practice pattern:\nexcept (SpecificError1, SpecificError2) as e:\n    log.error(f'Operation failed: {e}', exc_info=True)\n\nDon't go overboard - some broad catches are intentional. Focus on ones that could hide real bugs.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-09T09:43:36.879312+01:00","updated_at":"2025-12-09T09:43:36.879312+01:00"}
{"id":"claude-sync-kau","title":"Document status subcommand in CLAUDE.md and help text","description":"Document the new status subcommand in project documentation and CLI help.\n\n## Documentation Locations\n\n1. **CLAUDE.md** - Project instructions, used by Claude Code\n2. **CLI help text** - Typer docstrings shown in `--help`\n3. **README.md** (if exists) - User-facing documentation\n\n## Content to Add\n\n### CLAUDE.md\n\nAdd to Output Structure section:\n```markdown\n## Status Command\n\nCheck sync health without running a full sync:\n- `./claude_sync.py status` - Local status (no auth needed)\n- `./claude_sync.py status --remote` - Check for remote changes\n- `./claude_sync.py status --remote --check-docs` - Thorough doc checking\n```\n\n### CLI Help Text\n\n```python\n@app.command()\ndef status(\n    remote: bool = typer.Option(False, \"--remote\", \n        help=\"Check remote for changes (requires browser cookies)\"),\n    check_docs: bool = typer.Option(False, \"--check-docs\",\n        help=\"Fetch and hash docs to detect changes (slow, requires --remote)\"),\n    ...\n):\n    \"\"\"Show sync status and detect changes.\n    \n    Without --remote, shows local status only (no authentication needed):\n    - Last sync time and staleness\n    - Project, document, conversation counts\n    - Recently active projects\n    - Data integrity check\n    \n    With --remote, also checks claude.ai for changes:\n    - New projects available\n    - Modified project instructions\n    - New conversations\n    - Deleted projects\n    \n    Examples:\n        status                    # Quick local status\n        status --remote           # Check for changes on claude.ai\n        status --remote -p Lab    # Check specific project\n    \"\"\"\n```\n\n## Relation to Existing Beads\n\nThis can be done together with:\n- claude-sync-8dh: Update CLAUDE.md with output structure\n- claude-sync-2u0: Document --include-standalone flag\n\nConsider closing those beads as part of this work if they overlap.\n\n## Acceptance Criteria\n\n- [ ] `status --help` shows clear usage instructions\n- [ ] `status` docstring explains both modes\n- [ ] CLAUDE.md has status command documented\n- [ ] Examples are provided for common use cases\n\n## Files to Modify\n\n- `claude_sync.py`: Status command docstring\n- `CLAUDE.md`: Add status command section","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-09T09:51:14.401012+01:00","updated_at":"2025-12-09T09:51:14.401012+01:00","dependencies":[{"issue_id":"claude-sync-kau","depends_on_id":"claude-sync-ob7","type":"blocks","created_at":"2025-12-09T09:52:17.899149+01:00","created_by":"jason"},{"issue_id":"claude-sync-kau","depends_on_id":"claude-sync-g6g","type":"blocks","created_at":"2025-12-09T09:52:23.02567+01:00","created_by":"jason"}]}
{"id":"claude-sync-keb","title":"Bug: prompt_template changes not detected by incremental sync","description":"## Problem\nChanges to a project's `prompt_template` (the CLAUDE.md content) are **not detected** by incremental sync, causing users to work with stale project instructions.\n\n## Root Cause\nThe hash is computed but never checked!\n\nIn `build_project_state()` (line 855):\n```python\n\"prompt_template_hash\": compute_doc_hash(project.get(\"prompt_template\", \"\")),\n```\n\nBut in `project_needs_sync()` (lines 782-824), the function only checks:\n1. `updated_at` timestamp (line 805)\n2. Doc count (line 810)\n3. Doc content hashes (lines 814-822)\n\n**The prompt_template_hash is never compared!**\n\n## Scenario\n1. User syncs project with instructions \"Use TypeScript\"\n2. In claude.ai web UI, user changes instructions to \"Use Python\"\n3. API might not update `updated_at` for instruction-only changes (unverified)\n4. User runs incremental sync\n5. Sync says \"unchanged\" because updated_at matches\n6. Local CLAUDE.md still says \"Use TypeScript\"\n7. User works with wrong instructions\n\n## Implementation Fix\nAdd to `project_needs_sync()` after line 806:\n\n```python\n# Check prompt_template changed\ncurrent_template_hash = compute_doc_hash(project.get(\"prompt_template\", \"\"))\nprev_template_hash = prev_project.get(\"prompt_template_hash\", \"\")\nif current_template_hash != prev_template_hash:\n    return True, \"instructions changed\"\n```\n\n## Gotchas\n- Need to compute hash from current project data, not just compare stored values\n- The `project` parameter to `project_needs_sync()` is the CURRENT project from API\n- Make sure to handle case where prev_project has no prompt_template_hash (old state format)\n\n## Why This Might Have Been Missed\n- The API's `updated_at` timestamp MIGHT always update when prompt_template changes\n- If so, the timestamp check catches it\n- But if not (or if API behavior changes), we need the hash check as backup\n\n## Test Plan\n1. Sync a project with known prompt_template\n2. Manually modify .sync-state.json to:\n   - Keep same updated_at\n   - Change prompt_template_hash to different value\n3. Run incremental sync\n4. Verify project is detected as \"instructions changed\"\n5. Verify CLAUDE.md is re-written\n\n### Real-world test (if possible)\n1. Sync project\n2. Change instructions in claude.ai web UI\n3. Run sync\n4. Check if change detected\n\n## Before Closing\n- [ ] Add prompt_template_hash comparison to project_needs_sync()\n- [ ] Handle missing hash in old state format\n- [ ] Add unit test for hash comparison\n- [ ] Test with manual state modification\n- [ ] git commit","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-07T15:13:51.468565+01:00","updated_at":"2025-12-07T15:31:36.073783+01:00","closed_at":"2025-12-07T15:31:36.073783+01:00"}
{"id":"claude-sync-l4u","title":"Use atomic writes for index.json and .sync-state.json","description":"## Problem\nCritical state files are written directly, not atomically. If process is killed during write, files become corrupted/truncated.\n\n## Affected Files\n- `index.json` (line 729)\n- `.sync-state.json` (line 777)\n\n## Current Code\n```python\n# Line 729\nindex_path.write_text(json.dumps(index, indent=2), encoding=\"utf-8\")\n\n# Line 777\nwith open(state_path, \"w\") as f:\n    json.dump(state, f, indent=2)\n```\n\n## Risk Scenario\n1. Sync running, about to write .sync-state.json\n2. Process killed (Ctrl+C, power loss, OOM killer)\n3. File partially written (truncated JSON)\n4. Next sync: `json.load()` fails with JSONDecodeError\n5. User must manually delete corrupted file\n\n## Atomic Write Pattern\n```python\nimport tempfile\n\ndef atomic_write_json(path: Path, data: dict) -\u003e None:\n    \"\"\"Write JSON file atomically using temp file + rename.\"\"\"\n    # Create temp file in same directory (ensures same filesystem)\n    fd, tmp_path = tempfile.mkstemp(\n        dir=path.parent,\n        prefix=f'.{path.name}.',\n        suffix='.tmp'\n    )\n    tmp = Path(tmp_path)\n    \n    try:\n        with os.fdopen(fd, 'w') as f:\n            json.dump(data, f, indent=2)\n            f.flush()\n            os.fsync(f.fileno())  # Ensure written to disk\n        \n        # Atomic rename (POSIX guarantees)\n        tmp.replace(path)\n    except:\n        # Clean up temp file on error\n        tmp.unlink(missing_ok=True)\n        raise\n```\n\n## Why This Works\n- `os.rename()` / `Path.replace()` is atomic on POSIX systems\n- Either old file exists, or new file exists, never partial\n- Temp file in same directory ensures same filesystem\n- `fsync()` ensures data actually on disk before rename\n\n## Windows Considerations\n- `os.replace()` is atomic on Windows for same-volume renames\n- May need `win32file.MoveFileEx()` for cross-volume (not our case)\n\n## Implementation Locations\n\n### write_index() at line 729\n```python\ndef write_index(...):\n    # ... build index dict ...\n    atomic_write_json(output_dir / \"index.json\", index)\n    log.info(f\"Wrote {index_path}\")\n```\n\n### save_sync_state() at line 777\n```python\ndef save_sync_state(output_dir: Path, state: dict) -\u003e None:\n    \"\"\"Save sync state atomically.\"\"\"\n    state_path = output_dir / SYNC_STATE_FILE\n    atomic_write_json(state_path, state)\n    log.debug(f\"Saved sync state to {state_path}\")\n```\n\n## Gotchas\n- Temp file must be on same filesystem (same parent directory)\n- Must handle cleanup on exception\n- fsync() is important - without it, data might be in OS buffer only\n- Don't use NamedTemporaryFile with delete=True (race condition)\n\n## Test Plan\n1. Write test that:\n   - Creates atomic_write_json function\n   - Starts write\n   - Simulates crash (raise exception mid-write)\n   - Verifies original file unchanged OR new file complete\n   \n2. Stress test:\n   - Write large JSON repeatedly\n   - Kill process randomly\n   - Verify file always valid JSON\n\n## Before Closing\n- [ ] Implement atomic_write_json() helper\n- [ ] Update write_index() to use it\n- [ ] Update save_sync_state() to use it\n- [ ] Test crash recovery\n- [ ] git commit","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-07T15:16:05.866874+01:00","updated_at":"2025-12-07T17:13:30.679047+01:00","closed_at":"2025-12-07T17:13:30.679047+01:00"}
{"id":"claude-sync-nr2","title":"Document git recovery workflow in README","description":"**Original task**: claude-sync-3ha.2 (partially implemented)\n\n**What was missing**: Didn't test or document the git recovery workflow.\n\n## Required Documentation\nAdd to README.md a section explaining how to recover from accidental overwrites:\n\n### Recovery Workflow\n1. Run sync (creates git history)\n2. Manually modify a file (e.g., add local notes to CLAUDE.md)\n3. Run sync again (overwrites your changes)\n4. Use git to recover:\n   ```bash\n   cd ~/.local/share/claude-sync\n   git diff HEAD~1 -- \u003cproject\u003e/CLAUDE.md  # See what changed\n   git checkout HEAD~1 -- \u003cproject\u003e/CLAUDE.md  # Restore previous version\n   ```\n\n### Best Practice\n- Don't manually edit synced files\n- If you need local modifications, create separate files\n- Or use git branches for local changes\n\n## Test\nVerify this workflow actually works before documenting.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-07T15:00:19.807556+01:00","updated_at":"2025-12-07T17:06:07.084929+01:00","closed_at":"2025-12-07T17:06:07.084929+01:00"}
{"id":"claude-sync-ob7","title":"Implement Rich-based status output formatting","description":"Implement clean, readable output formatting for the status command using Rich library.\n\n## Requirements\n\n1. **Terminal-aware**: Colors and formatting in terminal, plain text when piped\n2. **Scannable**: Clear sections, good hierarchy\n3. **Agent-friendly**: Works well when invoked by Claude Code bash tool\n\n## Rich Auto-Detection\n\nRich automatically detects if stdout is a terminal:\n- Terminal: Colors, bold, tables with borders\n- Piped: Plain text, no ANSI codes\n\nVerified behavior:\n```python\n\u003e\u003e\u003e Console().is_terminal  # False when piped\n\u003e\u003e\u003e console.print(\"[bold green]Test[/]\")  # Outputs \"Test\" (no codes)\n```\n\n## Output Structure\n\n### Local Status\n```\nclaude-sync Status\n==================\n\nLast sync: 2025-12-07 13:16:30 UTC (2 days ago)\nLocation: ~/.local/share/claude-sync/\n\nSummary:\n  Projects: 17 synced\n  Documents: 158 total\n  Conversations: 0 (use --include-standalone on sync)\n  Orphaned: 0\n\nRecently Active (by last sync update):\n  Apart Lab General    23 docs   Dec 7\n  Therapie             66 docs   Dec 7\n  AGI Strategy         30 docs   Dec 7\n\nIntegrity: OK\n\nUse --remote to check for changes on claude.ai\n```\n\n### Remote Status (additions)\n```\nChanges Detected:\n  [NEW]  \"API Testing\" - new project\n  [MOD]  \"Apart Lab General\" - instructions changed, +3 conversations\n  [DEL]  \"Old Project\" - deleted remotely\n\nSummary: 1 new, 1 modified, 1 deleted\n```\n\n## Color Scheme (terminal only)\n\n- Green: OK, unchanged, counts\n- Yellow: Warnings, modifications\n- Red: Errors, deletions\n- Cyan: New items\n- Bold: Section headers, important values\n\n## Acceptance Criteria\n\n- [ ] Output is readable in terminal with colors\n- [ ] Output is clean plain text when piped (`status | cat`)\n- [ ] Works correctly in Claude Code bash tool (verified: is_terminal=False)\n- [ ] Sections are clearly separated\n- [ ] Numbers and dates are aligned for easy scanning\n- [ ] No Rich escape codes in piped output\n\n## Implementation\n\n```python\nfrom rich.console import Console\nfrom rich.table import Table\n\ndef format_status(status: dict, remote: dict = None) -\u003e None:\n    console = Console()  # Auto-detects terminal\n    \n    # Header\n    console.print(\"[bold]claude-sync Status[/bold]\")\n    console.print(\"=\" * 40)\n    \n    # Summary section\n    console.print(f\"\\\\nLast sync: {status['synced_at']} ({status['age_human']})\")\n    ...\n```\n\n## Files to Modify\n\n- `claude_sync.py`: Add `format_local_status()` and `format_remote_status()` functions","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-09T09:50:53.51128+01:00","updated_at":"2025-12-09T10:18:07.206648+01:00","closed_at":"2025-12-09T10:18:07.206648+01:00","dependencies":[{"issue_id":"claude-sync-ob7","depends_on_id":"claude-sync-3do","type":"blocks","created_at":"2025-12-09T09:52:02.507714+01:00","created_by":"jason"}]}
{"id":"claude-sync-omm","title":"Document API field assumptions for future maintainers","description":"Create documentation of all API field assumptions for agents and humans working on this codebase.\n\nThe code assumes ~8+ critical fields exist in API responses without validation:\n- project.uuid, project.prompt_template\n- doc.file_name, doc.content, doc.uuid  \n- conversation.chat_messages\n- message.content[].type, message.created_at\n\nIf Claude.ai API changes these fields, the code fails silently or crashes.\n\nCreate a section in docs/ or CLAUDE.md documenting:\n1. All assumed API fields and their expected types\n2. What happens if each field is missing\n3. Which failures are silent vs crash\n\nThis helps:\n- Future maintainers understand fragility points\n- Agents working on the codebase know what to watch for\n- Debugging when API changes break things\n\nLocation: Could be docs/API_CONTRACT.md or a section in CLAUDE.md","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-09T09:42:14.598403+01:00","updated_at":"2025-12-09T09:42:14.598403+01:00"}
{"id":"claude-sync-pxk","title":"Add status subcommand for sync health reporting","description":"Add a `status` subcommand to provide useful sync health information for both humans and agents.\n\n## Overview\n\nTwo modes:\n- **Local-only** (default, no auth): Fast check of cached state, staleness, integrity\n- **Remote comparison** (`--remote`): API check for changes (requires browser cookies)\n\n## Motivation\n\nCurrently there is no way to quickly check:\n- When was the last sync?\n- What projects are synced?\n- Are there changes on claude.ai that need syncing?\n- Is the local data in good shape?\n\nBoth humans and agents (like Claude Code) need this visibility.\n\n## Key Features\n\n1. Local status: staleness, project/doc/conversation counts, integrity check\n2. Recently active projects: show which projects had recent activity\n3. Remote comparison: detect new/modified/deleted projects\n4. Optional thorough doc checking via --check-docs\n\n## Design Decisions\n\n- Subcommand (not flag): `claude_sync.py status`\n- Rich output with auto-detection (works in terminal and when piped)\n- Local mode works offline, remote mode reuses existing cookie auth\n\n## Sub-tasks\n\nThis epic is broken into smaller beads:\n1. CLI refactor for subcommands\n2. Local status implementation\n3. Remote comparison implementation\n4. Optional doc checking\n5. Output formatting\n6. Documentation\n\nSee linked beads for details.","status":"open","priority":1,"issue_type":"feature","created_at":"2025-12-09T09:48:52.853304+01:00","updated_at":"2025-12-09T09:49:14.999197+01:00","dependencies":[{"issue_id":"claude-sync-pxk","depends_on_id":"claude-sync-3do","type":"blocks","created_at":"2025-12-09T09:54:59.256075+01:00","created_by":"jason"},{"issue_id":"claude-sync-pxk","depends_on_id":"claude-sync-aza","type":"blocks","created_at":"2025-12-09T09:55:04.386169+01:00","created_by":"jason"},{"issue_id":"claude-sync-pxk","depends_on_id":"claude-sync-ob7","type":"blocks","created_at":"2025-12-09T09:55:09.510794+01:00","created_by":"jason"},{"issue_id":"claude-sync-pxk","depends_on_id":"claude-sync-w62","type":"blocks","created_at":"2025-12-09T09:55:14.638199+01:00","created_by":"jason"},{"issue_id":"claude-sync-pxk","depends_on_id":"claude-sync-g6g","type":"blocks","created_at":"2025-12-09T09:55:19.774345+01:00","created_by":"jason"},{"issue_id":"claude-sync-pxk","depends_on_id":"claude-sync-kau","type":"blocks","created_at":"2025-12-09T09:55:24.908217+01:00","created_by":"jason"}]}
{"id":"claude-sync-siu","title":"Final documentation consistency review","description":"After all other issues are resolved, do a final pass to ensure all documentation is consistent.\n\nCheck ALL markdown files:\n- CLAUDE.md\n- README.md\n- docs/IMPLEMENTATION_NOTES.md\n- docs/RESEARCH.md\n- docs/TESTING.md\n\nVerify:\n1. Output structure matches in all places\n2. CLI flags documented consistently\n3. No outdated information\n4. Terminology is consistent\n5. No placeholder/personal values (usernames, paths)\n6. New features from other issues are documented\n\nThis is the FINAL documentation task - depends on all other issues being closed first.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-09T09:44:15.988816+01:00","updated_at":"2025-12-09T09:44:15.988816+01:00","dependencies":[{"issue_id":"claude-sync-siu","depends_on_id":"claude-sync-8dh","type":"blocks","created_at":"2025-12-09T09:44:15.990006+01:00","created_by":"jason"},{"issue_id":"claude-sync-siu","depends_on_id":"claude-sync-2u0","type":"blocks","created_at":"2025-12-09T09:44:15.990644+01:00","created_by":"jason"},{"issue_id":"claude-sync-siu","depends_on_id":"claude-sync-53h","type":"blocks","created_at":"2025-12-09T09:44:15.991081+01:00","created_by":"jason"},{"issue_id":"claude-sync-siu","depends_on_id":"claude-sync-omm","type":"blocks","created_at":"2025-12-09T09:44:15.991488+01:00","created_by":"jason"}]}
{"id":"claude-sync-u5c","title":"Add disk space check before sync","description":"## Problem\nSync doesn't check available disk space before starting, leading to:\n- Partial writes when disk fills\n- Corrupted files\n- Unhelpful \"Sync failed\" error message\n\n## Scenario\n1. User has 100MB free disk space\n2. Sync attempts to write 500MB of conversations\n3. Disk fills during sync\n4. Multiple partial/corrupted files left on disk\n5. User gets generic error, no indication of root cause\n\n## Implementation\n\n### Pre-flight check\n```python\nimport shutil\n\ndef check_disk_space(output_dir: Path, required_mb: int = 100) -\u003e None:\n    \"\"\"Check if enough disk space available.\n    \n    Args:\n        output_dir: Directory to check\n        required_mb: Minimum free space in MB (default 100)\n    \n    Raises:\n        RuntimeError: If insufficient disk space\n    \"\"\"\n    # Ensure directory exists for statvfs\n    output_dir.mkdir(parents=True, exist_ok=True)\n    \n    stat = shutil.disk_usage(output_dir)\n    free_mb = stat.free // (1024 * 1024)\n    \n    if free_mb \u003c required_mb:\n        raise RuntimeError(\n            f\"Insufficient disk space: {free_mb}MB available, {required_mb}MB required.\\n\"\n            f\"Free up space or use a different output directory.\"\n        )\n    \n    log.debug(f\"Disk space OK: {free_mb}MB available\")\n```\n\n### Where to call\nIn `sync()` before fetching projects:\n```python\ndef sync(config: Config) -\u003e int:\n    # Check disk space first (before any API calls)\n    try:\n        check_disk_space(config.output_dir)\n    except RuntimeError as e:\n        log.error(str(e))\n        return 1\n    \n    # ... rest of sync ...\n```\n\n### Dynamic estimation (optional, more complex)\n```python\ndef estimate_sync_size(projects: list[dict]) -\u003e int:\n    \"\"\"Estimate total bytes needed for sync.\"\"\"\n    total = 0\n    for project in projects:\n        # Base: meta.json + CLAUDE.md (~10KB)\n        total += 10 * 1024\n        # Docs: estimate from doc count\n        doc_count = project.get('_docs_count', 0)\n        total += doc_count * 50 * 1024  # ~50KB average per doc\n        # Conversations: estimate from convo count (if syncing)\n        convo_count = project.get('_conversations_count', 0)\n        total += convo_count * 100 * 1024  # ~100KB average per convo\n    return total\n```\n\n## Gotchas\n- shutil.disk_usage() is cross-platform (works on Windows too)\n- Check AFTER mkdir to ensure we're checking the right filesystem\n- Output dir might be on different mount than home dir\n- Consider: symlinks could point to different filesystem\n\n## Configuration\nAdd CLI flag for custom requirement:\n```python\nparser.add_argument(\n    \"--min-disk-mb\",\n    type=int,\n    default=100,\n    help=\"Minimum free disk space in MB (default: 100)\"\n)\n```\n\n## Test Plan\n1. Create small tmpfs or disk image with limited space\n2. Point output to that location\n3. Run sync with large dataset\n4. Verify:\n   - Error message mentions disk space\n   - No partial files created\n   - Exit code is non-zero\n\n## Before Closing\n- [ ] Implement check_disk_space()\n- [ ] Add to sync() before API calls\n- [ ] Add --min-disk-mb CLI option (optional)\n- [ ] Test with limited disk space\n- [ ] git commit","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-07T15:15:40.549205+01:00","updated_at":"2025-12-07T15:37:05.071838+01:00","closed_at":"2025-12-07T15:37:05.071838+01:00"}
{"id":"claude-sync-vjk","title":"Improve error messages to be actionable","description":"Error messages don't tell users what to do next. Apply 80/20 principle - improve the most common/confusing errors.\n\nPriority errors to improve:\n1. Rate limit error - should say how long to wait, whether retry is automatic\n2. Slug collision - should give exact command to fix\n3. Auth failures - should list specific steps (close browser, re-login, etc.)\n4. Lock file blocked - should explain if PID is stale, how to recover\n\nDon't over-engineer:\n- Standard Python errors that already report useful info are fine\n- Don't add custom logic where built-in errors suffice\n- Focus on errors that are confusing or have recovery steps\n\nGoal: Errors should be useful to both humans and agents working with the tool.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-09T09:43:22.269168+01:00","updated_at":"2025-12-09T09:43:22.269168+01:00"}
{"id":"claude-sync-w62","title":"Implement remote comparison for status --remote","description":"Implement remote comparison to detect changes on claude.ai since last sync.\n\n## Overview\n\nWhen `status --remote` is invoked, fetch the project list from claude.ai API and compare with local state to identify:\n- New projects (on remote, not in local)\n- Deleted projects (in local, not on remote)\n- Modified projects (different updated_at or instruction hash)\n- New/modified conversations\n\n## API Calls Required\n\n1. `GET /organizations/{org}/projects` - Get all project metadata\n2. For each potentially changed project:\n   - `GET /organizations/{org}/projects/{id}` - Get prompt_template for hash comparison\n   - `GET /organizations/{org}/projects/{id}/conversations?tree=true` - Get conversation list\n\n## Change Detection Logic\n\n### Project Level\n```python\nremote_uuids = {p[\"uuid\"] for p in remote_projects}\nlocal_uuids = set(local_state[\"projects\"].keys())\n\nnew = remote_uuids - local_uuids\ndeleted = local_uuids - remote_uuids\nmaybe_changed = remote_uuids \u0026 local_uuids\n```\n\n### Instruction Changes\n- Fetch prompt_template for projects where updated_at differs\n- Hash and compare with cached prompt_template_hash in .sync-state.json\n\n### Conversation Changes\n- Compare conversation updated_at timestamps\n- Count new conversations (uuid not in local state)\n\n## Output\n\n```\nChanges Detected:\n  [NEW]  \"API Testing\" - new project (created Dec 8)\n  [MOD]  \"Apart Lab General\"\n         - Instructions: changed\n         - Docs: 23 (changes unknown - run sync or --check-docs)\n         - Conversations: +3 new\n  [DEL]  \"Old Project\" - deleted remotely\n\nSummary: 1 new, 1 modified, 1 deleted\n```\n\n## Acceptance Criteria\n\n- [ ] `status --remote` authenticates using browser cookies\n- [ ] Correctly identifies new projects on remote\n- [ ] Correctly identifies deleted projects (local only)\n- [ ] Detects instruction changes via hash comparison\n- [ ] Counts new/modified conversations\n- [ ] Shows summary of what would sync\n- [ ] Handles API errors gracefully (expired session, network issues)\n\n## Implementation Notes\n\n- Reuse existing `get_session_cookies()`, `create_session()`, `fetch_projects()`\n- Cache fetched data to avoid duplicate API calls\n- Consider progress indicator for API calls\n\n## Files to Modify\n\n- `claude_sync.py`: Add `fetch_remote_status()` and `compare_remote_local()` functions","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-09T09:50:12.855256+01:00","updated_at":"2025-12-09T09:50:12.855256+01:00","dependencies":[{"issue_id":"claude-sync-w62","depends_on_id":"claude-sync-aza","type":"blocks","created_at":"2025-12-09T09:52:07.64022+01:00","created_by":"jason"}]}
{"id":"claude-sync-w6i","title":"Multi-org support: restructure index.json for multi-account sync","description":"## Problem\n\nCurrently, claude-sync assumes a single Claude account/org. The index.json stores one `org_id` at the root level, and syncing a different account overwrites this entirely. Users with multiple Claude accounts (e.g., personal vs work, or switching plans) lose track of which projects came from which account.\n\n## Goal\n\nEnable syncing multiple accounts over time to the same output directory, with metadata that allows both humans and agents to understand project provenance.\n\n## Key Insight\n\nAuthentication is session-based (browser cookies), so users sync one account at a time. This is fine - the issue is purely about **data model**, not auth. When a user syncs account B after previously syncing account A, both should coexist in the index.\n\n## Solution\n\n### 1. Restructure index.json (primary change)\n\n**Current structure:**\n```json\n{\n  \"synced_at\": \"...\",\n  \"org_id\": \"f3e5048f-...\",\n  \"projects\": {\n    \"project-uuid\": {...}\n  }\n}\n```\n\n**New structure:**\n```json\n{\n  \"orgs\": {\n    \"f3e5048f-...\": {\n      \"name\": \"Personal\",\n      \"synced_at\": \"2025-12-07T...\",\n      \"projects\": {\n        \"project-uuid-1\": {\n          \"name\": \"Project A\",\n          \"slug\": \"project-a-uuid1\",\n          \"path\": \"project-a-uuid1/\",\n          \"updated_at\": \"...\",\n          \"docs_count\": 5\n        }\n      },\n      \"standalone_conversations\": {\n        \"count\": 3,\n        \"path\": \"_standalone/\"\n      }\n    },\n    \"abc12345-...\": {\n      \"name\": \"Work Team\",\n      \"synced_at\": \"2025-12-01T...\",\n      \"projects\": {\n        \"project-uuid-2\": {...}\n      }\n    }\n  }\n}\n```\n\n### 2. Directory structure stays FLAT\n\nProject slugs already include UUID suffixes (e.g., `project-name-abc123`), so collisions across orgs are not a concern. No need for org-namespaced directories.\n\nOne exception: `_standalone/` conversations should probably become `_standalone-\u003corg-uuid-prefix\u003e/` to avoid collision, OR conversations should include org metadata in their own index.\n\n### 3. Code changes\n\n**write_index() in claude_sync.py (~line 1065):**\n- Read existing index.json first (if exists)\n- Merge new org data into `orgs` dict, preserving other orgs\n- Write back the combined structure\n\n**Sync state:**\n- `.sync-state.json` may need org-scoping too, or it can remain flat since project UUIDs are unique\n\n**Read paths:**\n- Any code that reads index.json needs to handle new structure\n- Consider backward compat: if old format detected, migrate on next sync\n\n### 4. Documentation updates\n\n**CLAUDE.md:** Add note that multi-org sync is supported, projects retain provenance\n\n**docs/RESEARCH.md:** Document the data model change\n\n**Agent awareness:** The index structure is self-documenting - agents reading index.json will see org names/IDs and can determine provenance\n\n## Testing considerations\n\n- Sync org A, then org B - verify both preserved\n- Re-sync org A - verify org A updated, org B unchanged  \n- Orphaned project handling per-org\n- Standalone conversations per-org\n\n## Non-goals\n\n- Simultaneous multi-account auth (not possible with browser cookie model)\n- Org-namespaced directories (unnecessary complexity)\n- Account email storage (org UUID + name sufficient, email could change)","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-09T09:34:12.522008+01:00","updated_at":"2025-12-09T09:34:38.65792+01:00"}
{"id":"claude-sync-xf6","title":"CRITICAL: Silent data loss in --no-git mode (no backup before overwrite)","description":"## Problem\nWhen running with `--no-git`, local file modifications are **silently overwritten** with no backup, warning, or recovery path.\n\n## Scenario\n1. User runs `./claude_sync.py --no-git`\n2. User manually edits `~/.local/share/claude-sync/my-project/CLAUDE.md` with local notes\n3. User runs sync again\n4. Remote version **silently overwrites** local changes\n5. **Data permanently lost** - no backup, no git history, no warning\n\n## Root Cause\n`write_project_output()` at line 634 does unconditional write:\n```python\nclaude_md_path.write_text(claude_md_content, encoding=\"utf-8\")\n```\n\nNo check for:\n- File existence\n- Local modifications (mtime comparison)\n- Content differences\n\n## Current Safeguard\nGit auto-commit (lines 1251-1252) provides history, BUT:\n- Disabled with `--no-git` flag\n- No fallback safety mechanism\n- User may not realize git is their only protection\n\n## Implementation Hints\n\n**Option A: Backup directory (recommended)**\n```python\ndef backup_if_modified(file_path: Path, backup_dir: Path) -\u003e bool:\n    \"\"\"Create timestamped backup if file exists and differs.\"\"\"\n    if not file_path.exists():\n        return False\n    \n    backup_dir.mkdir(parents=True, exist_ok=True)\n    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n    backup_path = backup_dir / f'{file_path.name}.{timestamp}.bak'\n    shutil.copy2(file_path, backup_path)\n    log.info(f'Backed up modified file: {backup_path}')\n    return True\n```\n\n**Option B: Warn and require --force**\n```python\nif file_path.exists() and not config.force:\n    log.warning(f'File exists: {file_path}. Use --force to overwrite.')\n    return\n```\n\n**Option C: Diff and prompt (interactive)**\n- Show diff of local vs remote\n- Ask user to confirm overwrite\n\n## Recommended Approach\n1. Always create backup in `.backup/` subdirectory (even with git)\n2. Keep last N backups (e.g., 5) per file\n3. Log when backup created\n4. Add `--no-backup` flag for users who really don't want it\n\n## Backup Directory Structure\n```\n~/.local/share/claude-sync/\n├── .backup/\n│   └── my-project/\n│       ├── CLAUDE.md.20251207_143022.bak\n│       └── CLAUDE.md.20251207_150155.bak\n└── my-project/\n    └── CLAUDE.md\n```\n\n## Gotchas\n- Backup rotation: Don't let .backup/ grow unbounded\n- Binary files: Should work but verify\n- Symlinks: Backup target, not symlink itself\n- Permissions: Preserve original file permissions in backup\n\n## Test Plan\n1. Sync a project\n2. Manually edit CLAUDE.md (add unique marker text)\n3. Run sync again with --no-git\n4. Verify:\n   - Backup created in .backup/\n   - Original content preserved in backup\n   - New content written to CLAUDE.md\n   - Log message shows backup was created\n\n## Before Closing\n- [ ] Implement backup mechanism\n- [ ] Add backup rotation (keep last N)\n- [ ] Add --no-backup flag\n- [ ] Test backup creation\n- [ ] Test backup rotation\n- [ ] git commit with tests","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-07T15:12:34.145872+01:00","updated_at":"2025-12-07T15:36:54.591987+01:00","closed_at":"2025-12-07T15:36:54.591987+01:00"}
{"id":"claude-sync-z39","title":"Add stale lock file detection","description":"If a sync crashes, the lock file remains and blocks future syncs forever.\n\nCurrent behavior:\n- Lock file written with PID\n- If sync crashes (kill -9), lock file remains\n- Next sync: 'Another sync is running (PID: 12345)'\n- User must manually delete lock file\n\nProblem:\n- PID 12345 might be dead or recycled to different process\n- No automatic recovery\n\nFix options (in order of simplicity):\n1. Check if PID is still alive before failing\n   - os.kill(pid, 0) to check if process exists\n   - If not alive, remove stale lock and proceed\n\n2. Add lock file TTL (e.g., 30 min)\n   - Check mtime of lock file\n   - If older than TTL, consider stale\n\n3. Add --force-unlock flag for manual override\n\nRecommend option 1 (simplest, most reliable on Unix).\n\nNote: os.kill(pid, 0) doesn't actually send signal, just checks if process exists.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-09T09:44:04.010062+01:00","updated_at":"2025-12-09T09:44:04.010062+01:00"}
{"id":"claude-sync-zar","title":"Archive old Claude migration folder","description":"Clean up the old /Users/jason/Documents/Claude migration/ folder:\n\n## Current Contents\n- Claude-data-2025-04-03-12-15-45/ - Raw export (keep for reference)\n- old/ - Old scripts (archived to reference/)\n- process_projects.py - Old script (archived to reference/)\n- processed_projects*/ - Processed output (can delete after verifying new tool works)\n- PDF - refund email (personal, not relevant)\n- SYNC_PROJECT_PLAN.md - Moved to docs/RESEARCH.md\n\n## Actions\n1. Verify new claude-sync tool works\n2. Delete processed_projects* folders (redundant)\n3. Keep raw export in Documents for now\n4. Consider moving to archive location\n\n## Note\nDon't delete anything until MVP is working and tested!","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-07T13:17:39.190855+01:00","updated_at":"2025-12-07T14:27:16.393841+01:00","closed_at":"2025-12-07T14:27:16.393841+01:00"}
